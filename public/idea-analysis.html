<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>تحلیل حرفه‌ای ایده</title>
  <style>
    body {
      font-family: 'Vazirmatn', sans-serif;
      background: #f4f6f9;
      max-width: 950px;
      margin: 40px auto;
      padding: 20px;
      color: #333;
      line-height: 1.9;
    }
    h1 {
      text-align: center;
      border-bottom: 3px solid #3498db;
      padding-bottom: 10px;
      margin-bottom: 30px;
      color: #2c3e50;
    }
    .section {
      background: #fff;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.05);
    }
    .section h2 {
      color: #0057a3;
      font-size: 20px;
      margin-bottom: 15px;
    }
    .section h3 {
      color: #1f3b73;
      font-size: 18px;
      margin: 20px 0 10px;
    }
    .analysis-text {
      font-size: 16px;
      color: #444;
      margin-bottom: 15px;
    }
    .impact-list {
      list-style-type: disc;
      padding-right: 20px;
      font-size: 16px;
      color: #333;
    }
    .btn {
      background: #3498db;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: bold;
      margin: 10px 5px 0 0;
      cursor: pointer;
      transition: 0.3s;
    }
    .btn:hover { 
      background: #217dbb; 
    }
    .btn-red {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: bold;
      margin: 10px 5px 0 0;
      cursor: pointer;
      transition: 0.3s;
    }
    .btn-red:hover { 
      background: #c0392b; 
    }
    .btn-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 20px;
    }
    
    /* استایل‌های پاپ‌آپ */
    .popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      display: flex;
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.3s ease;
    }

    .popup-content {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      max-width: 400px;
      width: 90%;
      max-height: 80vh;
      overflow: hidden;
      animation: slideIn 0.3s ease;
    }

    .popup-header {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .popup-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
    }

    .popup-close {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background 0.3s ease;
    }

    .popup-close:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .popup-body {
      padding: 25px;
      text-align: center;
    }

    .popup-body p {
      margin: 0;
      font-size: 16px;
      line-height: 1.6;
      color: #333;
    }

    .popup-footer {
      padding: 20px;
      text-align: center;
      border-top: 1px solid #eee;
    }

    .popup-btn {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      font-family: 'Vazirmatn', sans-serif;
    }

    .popup-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(52, 152, 219, 0.4);
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideIn {
      from { 
        opacity: 0;
        transform: translateY(-50px) scale(0.9);
      }
      to { 
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* Revenue Models Styles - Clean & Simple */
    .revenue-models-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-top: 20px;
    }

    .revenue-content {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .revenue-content:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
    }

    .revenue-text {
      color: rgba(255, 255, 255, 0.95);
      line-height: 1.8;
      font-size: 1em;
      text-align: right;
      direction: rtl;
    }

    .revenue-text strong {
      color: #fff;
      font-weight: 600;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    .revenue-text br {
      margin-bottom: 8px;
    }

    .revenue-details {
      color: #555;
      font-size: 15px;
      line-height: 1.6;
    }

    .revenue-details strong {
      color: #2c3e50;
      font-weight: 600;
    }

    .loading-revenue {
      text-align: center;
      padding: 40px;
      color: #7f8c8d;
      font-size: 16px;
    }

    .revenue-error {
      background: #fdf2f2;
      border: 1px solid #fecaca;
      color: #e74c3c;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }

    .brand-section {
      margin-bottom: 30px;
    }

    .brand-section h3 {
      font-weight: 700;
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
  </style>
  
  <!-- پاپ‌آپ زیبا -->
  <div id="popup-overlay" class="popup-overlay" style="display: none;">
    <div class="popup-content">
      <div class="popup-header">
        <h3 id="popup-title">اطلاعیه</h3>
        <button class="popup-close" onclick="closePopup()">&times;</button>
      </div>
      <div class="popup-body">
        <p id="popup-message">پیام در اینجا نمایش داده می‌شود</p>
      </div>
      <div class="popup-footer">
        <button class="popup-btn" onclick="closePopup()">متوجه شدم</button>
      </div>
    </div>
  </div>
</head>
<body>

<h1 id="pageTitle">تحلیل حرفه‌ای ایده همکاری</h1>

<!-- Idea Information Section -->
<div class="section" id="ideaInfoSection" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 2px solid #dee2e6;">
  <h2 style="color: #495057; margin-bottom: 15px;">📋 اطلاعات ایده</h2>
  <div id="ideaInfo" style="font-size: 16px; line-height: 1.6;">
    <div style="margin-bottom: 10px;"><strong>عنوان ایده:</strong> <span id="ideaTitleDisplay">-</span></div>
    <div style="margin-bottom: 10px;"><strong>برند همکار:</strong> <span id="partnerNameDisplay">-</span></div>
    <div><strong>توضیحات:</strong> <span id="ideaDescriptionDisplay">-</span></div>
  </div>
</div>

<div class="section">
  <h2>چرا باید این ایده را از زاویه CSR، PR و Branding بررسی کرد؟</h2>
  <div id="analysis" class="analysis-text">⏳ در حال دریافت تحلیل...</div>
</div>

<!-- Revenue Models Section -->
<div class="section" id="revenueSection" style="display: none;">
  <h2>💰 مدل‌های درآمدی پیشنهادی</h2>
  
  <!-- My Brand Revenue Models -->
  <div class="brand-section">
    <h3 id="myBrandTitle" style="color: #2c3e50; font-size: 20px; margin: 20px 0 15px 0; padding: 10px; background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; border-radius: 8px; text-align: center;"></h3>
    <div id="myBrandRevenueModels" class="revenue-models-container">
      <!-- My brand revenue models will be displayed here -->
    </div>
  </div>
  
  <!-- Target Brand Revenue Models -->
  <div class="brand-section">
    <h3 id="targetBrandTitle" style="color: #2c3e50; font-size: 20px; margin: 20px 0 15px 0; padding: 10px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; border-radius: 8px; text-align: center;"></h3>
    <div id="targetBrandRevenueModels" class="revenue-models-container">
      <!-- Target brand revenue models will be displayed here -->
    </div>
  </div>
</div>


<div class="btn-container">
  <button class="btn" id="btnSample">📌 نمونه‌های اجرا شده</button>
  <button class="btn" id="btnBenefits">🤝 مزایا برای طرفین</button>
  <button class="btn" id="btnRevenue">💰 مدل‌های درآمدی</button>
  <button class="btn" id="btnEconomy">📊 توجیه اقتصادی</button>
  <button class="btn" id="btnStrategy">📈 یک استراتژی می‌خواهم</button>
  <button class="btn" id="btnCooperation" style="background: #27ae60; color: white;">🤝 پذیرفتن درخواست همکاری</button>
  
  <!-- دکمه‌های همکاری -->
  <div id="cooperationButtons" style="margin-top: 15px; text-align: center;">
    <!-- دکمه ارسال درخواست همکاری (برای ایده‌های خودم) -->
    <button id="sendCooperationBtn" onclick="sendCooperationRequest()" class="btn" style="background: #3498db; color: white; display: none;">
      🤝 ارسال درخواست همکاری
    </button>
    
    <!-- دکمه پذیرفتن همکاری (برای ایده‌های دریافتی) -->
    <button id="acceptCooperationBtn" onclick="acceptCooperation()" class="btn" style="background: #e74c3c; color: white; display: none;">
      ✅ پذیرفتن همکاری
    </button>
    
    <!-- دکمه قفل شده -->
    <button id="lockedBtn" class="btn" style="background: #95a5a6; color: white; display: none;" disabled>
      🔒 درخواست ارسال شده
    </button>
  </div>
  <button class="btn-red" id="btnBack">🔙 بازگشت به داشبورد</button>
</div>

<script>
async function fetchMyBrand() {
  const res = await fetch("/api/my-brand", { credentials: "include" });
  if (!res.ok) throw new Error("برند شما یافت نشد.");
  return await res.json();
}

function getTargetBrandId() {
  const params = new URLSearchParams(window.location.search);
  return params.get("target");
}

async function callOpenAI(prompt, myBrandId, targetBrandId) {
  const res = await fetch("/api/generate-ideas", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ 
      prompt, 
      myBrandId, 
      targetBrandId 
    })
  });

  if (!res.ok) {
    const err = await res.json();
    throw new Error(err.error?.message || "خطا در پاسخ OpenAI");
  }

  const data = await res.json();
  console.log("خام API OpenAI:", JSON.stringify(data, null, 2));
  return data.choices[0].message.content;
}

function splitAnalysisAndImpacts(text) {
  const analysis = text.trim();
  return { analysis };
}

function showFallbackAnalysis(ideaPrompt) {
  const analysisDiv = document.getElementById("analysis");
  
  // تحلیل ساده و کلی
  analysisDiv.innerHTML = `
    <div style="color: #2c3e50; background: #ecf0f1; padding: 15px; border-radius: 8px; border: 1px solid #bdc3c7;">
      <h4 style="margin: 0 0 10px 0;">📊 تحلیل کلی ایده</h4>
      <p style="margin: 0;">این ایده از زوایای مختلف (CSR، PR، Branding) قابل بررسی است و می‌تواند برای هر دو برند مزایای قابل توجهی به همراه داشته باشد.</p>
    </div>
  `;
}

async function loadIdeaAnalysis() {
  const ideaPrompt = sessionStorage.getItem("ideaPrompt");
  const analysisDiv = document.getElementById("analysis");

  // اگر ایده‌ای در sessionStorage نیست، پیام مناسب نمایش بده
  if (!ideaPrompt) {
    analysisDiv.innerHTML = `
      <div style="color: #f39c12; background: #fef9e7; padding: 15px; border-radius: 8px; border: 1px solid #f4d03f;">
        <h4 style="margin: 0 0 10px 0;">⚠️ اطلاعات ایده یافت نشد</h4>
        <p style="margin: 0;">لطفاً ابتدا از صفحه فرصت‌های همکاری یک ایده را انتخاب کنید.</p>
        <button onclick="window.history.back()" style="margin-top: 10px; padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
          🔙 بازگشت
        </button>
      </div>
    `;
    return;
  }

  try {
    // دریافت اطلاعات برندها
    const myBrand = await fetchMyBrand();
    console.log("🔍 Debug - myBrand:", myBrand);
    
    let targetBrandId = sessionStorage.getItem("targetBrandId");
    console.log("🔍 Debug - targetBrandId from sessionStorage:", targetBrandId);
    
    if (!targetBrandId) {
      throw new Error("شناسه برند هدف یافت نشد.");
    }

    const newPrompt = `
بر اساس اطلاعات زیر:
${ideaPrompt}

یک تحلیل غنی و پرمحتوا (۴–۵ خط) بنویس که توضیح دهد چرا این ایده باید از زاویه‌های مسئولیت اجتماعی (CSR)، روابط عمومی (PR) و برندسازی (Branding) بررسی شود. این تحلیل باید عمیق و متقاعدکننده باشد و مزایای این همکاری را از هر سه زاویه به طور جامع پوشش دهد.

هیچ مقدمه یا نتیجه‌گیری اضافه ننویس. فقط همین تحلیل را بنویس.
`;

    analysisDiv.textContent = "⏳ در حال تحلیل...";
    const response = await callOpenAI(newPrompt, myBrand._id, targetBrandId);
    const { analysis } = splitAnalysisAndImpacts(response);

    analysisDiv.innerHTML = analysis.replace(/\n/g, "<br>");
  } catch (err) {
    console.error("خطا در تحلیل ایده:", err);
    
    // اگر خطای اتصال است، پیام مناسب نمایش بده
    if (err.message.includes("سرویس تحلیل ایده‌ها موقتاً در دسترس نیست") || err.message.includes("خطا در API")) {
      // نمایش تحلیل ساده به جای پیام خطا
      showFallbackAnalysis(ideaPrompt);
    } else {
      analysisDiv.innerHTML = `
        <div style="color: #e74c3c; background: #fdf2f2; padding: 15px; border-radius: 8px; border: 1px solid #fecaca;">
          <h4 style="margin: 0 0 10px 0;">❌ خطا در تحلیل ایده</h4>
          <p style="margin: 0;">${err.message}</p>
          <button onclick="loadIdeaAnalysis()" style="margin-top: 10px; padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
            🔄 تلاش مجدد
          </button>
        </div>
      `;
    }
  }
}

// توابع پاپ‌آپ
function showPopup(title, message) {
  document.getElementById('popup-title').textContent = title;
  document.getElementById('popup-message').textContent = message;
  document.getElementById('popup-overlay').style.display = 'flex';
}

function closePopup() {
  document.getElementById('popup-overlay').style.display = 'none';
}

document.getElementById("btnEconomy").addEventListener("click", () => {
  showPopup("📊 توجیه اقتصادی", "این قابلیت به زودی فعال می‌شود و توجیه اقتصادی کامل ایده را ارائه می‌دهد.");
});

document.getElementById("btnSample").addEventListener("click", () => {
  showPopup("📌 نمونه‌های اجرا شده", "این قابلیت به زودی فعال می‌شود و نمونه‌های واقعی مشابه این ایده را معرفی می‌کند.");
});

document.getElementById("btnBenefits").addEventListener("click", () => {
  showPopup("🤝 مزایا برای طرفین", "این قابلیت به زودی فعال می‌شود و مزایای همکاری برای هر دو طرف را نشان می‌دهد.");
});

document.getElementById("btnRevenue").addEventListener("click", async () => {
  await generateRevenueModels();
});

document.getElementById("btnStrategy").addEventListener("click", () => {
  showPopup("📈 یک استراتژی می‌خواهم", "این قابلیت به زودی فعال می‌شود و استراتژی کاملاً اجرایی و جزئی را ارائه می‌دهد.");
});

document.getElementById("btnBack").addEventListener("click", () => {
  window.location.href = "dashboard.html";
});

document.getElementById("btnCooperation").addEventListener("click", async () => {
  await acceptCooperationRequest();
});

// پذیرفتن درخواست همکاری
async function acceptCooperationRequest() {
  try {
    const ideaTitle = sessionStorage.getItem("ideaTitle") || "ایده همکاری";
    const partnerName = sessionStorage.getItem("partnerName") || "برند همکار";
    const receivedRequestId = sessionStorage.getItem("receivedRequestId");
    
    if (!receivedRequestId) {
      showPopup("خطا", "شناسه درخواست همکاری یافت نشد");
      return;
    }

    const response = await fetch(`/api/cooperation-requests/${receivedRequestId}/accept`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      credentials: 'include'
    });

    if (response.ok) {
      // غیرفعال کردن دکمه
      const button = document.getElementById('btnCooperation');
      button.disabled = true;
      button.innerHTML = '<i class="fas fa-check"></i> درخواست پذیرفته شد';
      button.style.background = '#28a745';
      
      showPopup("موفقیت", `درخواست همکاری با موفقیت برای ${partnerName} پذیرفته شد!`);
    } else {
      const error = await response.json();
      showPopup("خطا", error.error || "خطا در پذیرش درخواست همکاری");
    }
  } catch (error) {
    console.error("خطا در پذیرش درخواست همکاری:", error);
    showPopup("خطا", "خطا در پذیرش درخواست همکاری");
  }
}

// تولید مدل‌های درآمدی
async function generateRevenueModels() {
  const revenueSection = document.getElementById("revenueSection");
  const myBrandRevenueModels = document.getElementById("myBrandRevenueModels");
  const targetBrandRevenueModels = document.getElementById("targetBrandRevenueModels");
  const btnRevenue = document.getElementById("btnRevenue");
  
  // نمایش بخش مدل‌های درآمدی
  revenueSection.style.display = "block";
  
  // نمایش حالت لودینگ
  myBrandRevenueModels.innerHTML = `
    <div class="loading-revenue">
      <div style="font-size: 24px; margin-bottom: 10px;">⏳</div>
      در حال تولید مدل‌های درآمدی خلاقانه...
    </div>
  `;
  
  targetBrandRevenueModels.innerHTML = `
    <div class="loading-revenue">
      <div style="font-size: 24px; margin-bottom: 10px;">⏳</div>
      در حال تولید مدل‌های درآمدی خلاقانه...
    </div>
  `;
  
  // غیرفعال کردن دکمه
  btnRevenue.disabled = true;
  btnRevenue.textContent = "⏳ در حال تولید...";
  
  try {
    // دریافت اطلاعات برندها
    const myBrand = await fetchMyBrand();
    const targetBrandId = sessionStorage.getItem("targetBrandId");
    const ideaDescription = sessionStorage.getItem("ideaDescription") || sessionStorage.getItem("ideaPrompt");
    
    if (!ideaDescription) {
      throw new Error("شرح ایده یافت نشد");
    }
    
    if (!targetBrandId) {
      throw new Error("شناسه برند هدف یافت نشد");
    }

    // فراخوانی API برای تولید مدل‌های درآمدی
    const response = await fetch("/api/generate-revenue-models", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ 
        ideaDescription, 
        myBrandId: myBrand._id, 
        targetBrandId 
      })
    });

    if (!response.ok) {
      const err = await response.json();
      throw new Error(err.error || "خطا در تولید مدل‌های درآمدی");
    }

    const data = await response.json();
    const revenueContent = data.choices[0].message.content;
    
    // پردازش و نمایش مدل‌های درآمدی
    await displayRevenueModels(revenueContent);
    
  } catch (error) {
    console.error("خطا در تولید مدل‌های درآمدی:", error);
    
    const errorHtml = `
      <div class="revenue-error">
        <h4 style="margin: 0 0 10px 0;">❌ خطا در تولید مدل‌های درآمدی</h4>
        <p style="margin: 0;">${error.message}</p>
        <button onclick="generateRevenueModels()" style="margin-top: 10px; padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
          🔄 تلاش مجدد
        </button>
      </div>
    `;
    
    myBrandRevenueModels.innerHTML = errorHtml;
    targetBrandRevenueModels.innerHTML = errorHtml;
  } finally {
    // فعال کردن مجدد دکمه
    btnRevenue.disabled = false;
    btnRevenue.textContent = "💰 مدل‌های درآمدی";
  }
}

// نمایش مدل‌های درآمدی
async function displayRevenueModels(content) {
  // دریافت اطلاعات برندها
  const myBrand = await fetchMyBrand();
  const targetBrandId = sessionStorage.getItem("targetBrandId");
  
  // دریافت اطلاعات برند هدف
  let targetBrand = null;
  if (targetBrandId) {
    try {
      const response = await fetch(`/api/brand/${targetBrandId}`, { credentials: 'include' });
      if (response.ok) {
        targetBrand = await response.json();
      }
    } catch (error) {
      console.error("خطا در دریافت اطلاعات برند هدف:", error);
    }
  }
  
  // تنظیم عناوین برندها
  document.getElementById("myBrandTitle").textContent = `مدل‌های درآمدی برای ${myBrand.name}`;
  document.getElementById("targetBrandTitle").textContent = `مدل‌های درآمدی برای ${targetBrand ? targetBrand.name : 'برند همکار'}`;
  
  // چاپ محتوای خام در کنسول
  console.log("🔍 محتوای دریافتی از API:");
  console.log("==================================================");
  console.log(content);
  console.log("==================================================");
  
  // تست ساده برای دیباگ
  if (content.includes('**برای')) {
    console.log("✅ ساختار **برای** پیدا شد");
  } else {
    console.log("❌ ساختار **برای** پیدا نشد");
  }
  
  if (content.match(/\d+\./)) {
    console.log("✅ ساختار شماره‌دار پیدا شد");
  } else {
    console.log("❌ ساختار شماره‌دار پیدا نشد");
  }
  
  // تقسیم محتوا به دو بخش: برند من و برند هدف
  console.log("🔍 محتوای کامل API:", content);
  console.log("🔍 طول محتوا:", content.length);
  
  // تقسیم ساده محتوا به دو بخش
  const midPoint = Math.floor(content.length / 2);
  const myBrandSection = content.substring(0, midPoint);
  const targetBrandSection = content.substring(midPoint);
  
  console.log("🔍 تقسیم ساده محتوا:");
  console.log("بخش اول (طول:", myBrandSection.length, "):", myBrandSection.substring(0, 100) + "...");
  console.log("بخش دوم (طول:", targetBrandSection.length, "):", targetBrandSection.substring(0, 100) + "...");
  
  console.log("🔍 بخش برند من (طول:", myBrandSection.length, "):", myBrandSection.substring(0, 500) + "...");
  console.log("🔍 بخش برند هدف (طول:", targetBrandSection.length, "):", targetBrandSection.substring(0, 500) + "...");
  
  // نمایش مدل‌های برند من
  displayBrandRevenueModels('myBrandRevenueModels', myBrandSection, myBrand.name);
  
  // نمایش مدل‌های برند هدف
  displayBrandRevenueModels('targetBrandRevenueModels', targetBrandSection, targetBrand ? targetBrand.name : 'برند همکار');
}

// نمایش مدل‌های درآمدی برای یک برند خاص
function displayBrandRevenueModels(containerId, content, brandName) {
  const container = document.getElementById(containerId);
  
  console.log(`🔍 نمایش مدل‌های درآمدی برای ${brandName}:`);
  console.log("محتوای ورودی:", content.substring(0, 300) + "...");
  
  if (!content.trim()) {
    container.innerHTML = `
      <div class="revenue-error">
        <p>مدل‌های درآمدی برای ${brandName} یافت نشد.</p>
      </div>
    `;
    return;
  }
  
  console.log(`🔍 نمایش محتوای ${brandName}:`, content.substring(0, 200) + "...");
  
  // نمایش ساده محتوا بدون پارسینگ پیچیده
  const formattedContent = content
    .replace(/\n/g, '<br>')
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/- (.*?):/g, '<br><strong>$1:</strong> ')
    .replace(/^\s*-\s*/gm, '<br>• ');
  
  const html = `
    <div class="revenue-content">
      <div class="revenue-text">
        ${formattedContent}
      </div>
    </div>
  `;
  
  // اگر هیچ مدلی پیدا نشد، محتوای خام را نمایش بده
  if (html === '') {
    console.log("🔍 هیچ مدلی پیدا نشد، نمایش محتوای خام");
    const formattedContent = content
      .replace(/\n/g, '<br>')
      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
      .replace(/- (.*?):/g, '<br><strong>$1:</strong> ')
      .replace(/^\s*-\s*/gm, '<br>• ');
    
    html = `
      <div class="revenue-content">
        <div class="revenue-text">
          ${formattedContent}
        </div>
      </div>
    `;
  }
  
  console.log(`🔍 HTML نهایی برای ${brandName}:`, html.substring(0, 200) + "...");
  container.innerHTML = html;
}

// بررسی وضعیت همکاری و نمایش دکمه‌های مناسب
async function checkCooperationStatus() {
  try {
    const ideaTitle = sessionStorage.getItem('ideaTitle');
    const ideaType = sessionStorage.getItem('ideaType');
    const myBrandId = sessionStorage.getItem('myBrandId');
    const targetBrandId = sessionStorage.getItem('targetBrandId');
    const messageId = sessionStorage.getItem('messageId');
    
    if (!ideaTitle) return;

    console.log('🔍 بررسی وضعیت همکاری:');
    console.log('ایده:', ideaTitle);
    console.log('نوع ایده:', ideaType);
    console.log('برند من:', myBrandId);
    console.log('برند هدف:', targetBrandId);
    console.log('پیام ID:', messageId);
    
    // بررسی همه sessionStorage
    console.log('🔍 همه sessionStorage:');
    for (let i = 0; i < sessionStorage.length; i++) {
      const key = sessionStorage.key(i);
      const value = sessionStorage.getItem(key);
      console.log(`${key}: ${value}`);
    }

    // مخفی کردن همه دکمه‌ها
    document.getElementById('sendCooperationBtn').style.display = 'none';
    document.getElementById('acceptCooperationBtn').style.display = 'none';
    document.getElementById('lockedBtn').style.display = 'none';

    // تشخیص نوع ایده - راه حل ساده و مطمئن
    // اگر messageId موجود باشد، یعنی ایده دریافتی است
    // اگر messageId موجود نباشد، یعنی ایده خودمان است
    const isReceivedIdea = messageId && messageId !== 'null' && messageId !== 'undefined';
    
    console.log('🔍 تشخیص نوع ایده:');
    console.log('messageId:', messageId);
    console.log('isReceivedIdea:', isReceivedIdea);
    console.log('ideaType از sessionStorage:', ideaType);
    
    if (!isReceivedIdea) {
      console.log('✅ این ایده متعلق به کاربر فعلی است - نمایش دکمه ارسال');
      
      // برای ایده‌های خودم، ابتدا دکمه ارسال درخواست همکاری را نمایش بده
      document.getElementById('sendCooperationBtn').style.display = 'inline-block';
      
      // بررسی وضعیت درخواست‌های ارسالی
      if (myBrandId && targetBrandId) {
        try {
          const response = await fetch(`/api/cooperation-status/${encodeURIComponent(ideaTitle)}`, {
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
          });

          if (response.ok) {
            const data = await response.json();
            console.log('📊 وضعیت درخواست‌های ارسالی:', data.sentRequests);
            
            if (data.sentRequests && data.sentRequests.length > 0) {
              const hasPending = data.sentRequests.some(req => req.status === 'pending');
              const hasAccepted = data.sentRequests.some(req => req.status === 'accepted');
              
              if (hasAccepted) {
                document.getElementById('sendCooperationBtn').style.display = 'none';
                document.getElementById('lockedBtn').textContent = '✅ همکاری پذیرفته شده';
                document.getElementById('lockedBtn').style.display = 'inline-block';
                console.log('✅ همکاری قبلاً پذیرفته شده');
              } else if (hasPending) {
                document.getElementById('sendCooperationBtn').style.display = 'none';
                document.getElementById('lockedBtn').textContent = '⏳ در انتظار پاسخ';
                document.getElementById('lockedBtn').style.display = 'inline-block';
                console.log('⏳ درخواست در انتظار پاسخ است');
              }
            } else {
              console.log('📝 هیچ درخواستی ارسال نشده - دکمه ارسال فعال است');
            }
          }
        } catch (error) {
          console.error('خطا در بررسی وضعیت درخواست‌ها:', error);
          // در صورت خطا، دکمه ارسال را فعال نگه دار
        }
      } else {
        console.log('⚠️ اطلاعات برند ناقص است - دکمه ارسال فعال است');
      }
      
    } else {
      console.log('📨 این ایده از طرف برند دیگری است - بررسی درخواست‌های دریافتی');
      
      // برای ایده‌های دریافتی، دکمه پذیرفتن همکاری را نمایش بده
      if (messageId) {
        document.getElementById('acceptCooperationBtn').style.display = 'inline-block';
        document.getElementById('acceptCooperationBtn').dataset.messageId = messageId;
      }
      
      // بررسی وضعیت درخواست‌های دریافتی
      const response = await fetch(`/api/cooperation-status/${encodeURIComponent(ideaTitle)}`, {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      });

      if (response.ok) {
        const data = await response.json();
        
        if (data.receivedRequests && data.receivedRequests.length > 0) {
          const pendingRequest = data.receivedRequests.find(req => req.status === 'pending');
          const acceptedRequest = data.receivedRequests.find(req => req.status === 'accepted');
          
          if (acceptedRequest) {
            document.getElementById('acceptCooperationBtn').style.display = 'none';
            document.getElementById('lockedBtn').textContent = '✅ همکاری پذیرفته شده';
            document.getElementById('lockedBtn').style.display = 'inline-block';
          } else if (pendingRequest) {
            document.getElementById('acceptCooperationBtn').style.display = 'inline-block';
            document.getElementById('acceptCooperationBtn').dataset.messageId = pendingRequest.messageId;
          }
        }
      }
    }

  } catch (error) {
    console.error('خطا در بررسی وضعیت همکاری:', error);
  }
}

// ارسال درخواست همکاری
async function sendCooperationRequest() {
  try {
    const targetBrandId = sessionStorage.getItem('targetBrandId');
    const ideaTitle = sessionStorage.getItem('ideaTitle');
    const ideaDescription = sessionStorage.getItem('ideaDescription');

    if (!targetBrandId || !ideaTitle) {
      alert('اطلاعات کافی برای ارسال درخواست وجود ندارد');
      return;
    }

    const response = await fetch('/api/cooperation-requests', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      },
      body: JSON.stringify({
        targetBrandId: targetBrandId,
        ideaTitle: ideaTitle,
        ideaDescription: ideaDescription
      })
    });

    if (response.ok) {
      alert('درخواست همکاری با موفقیت ارسال شد');
      // قفل کردن دکمه
      document.getElementById('sendCooperationBtn').style.display = 'none';
      document.getElementById('lockedBtn').textContent = '⏳ در انتظار پاسخ';
      document.getElementById('lockedBtn').style.display = 'inline-block';
    } else {
      const error = await response.json();
      alert('خطا در ارسال درخواست: ' + error.error);
    }

  } catch (error) {
    console.error('خطا در ارسال درخواست همکاری:', error);
    alert('خطا در ارسال درخواست همکاری');
  }
}

// پذیرفتن همکاری
async function acceptCooperation() {
  try {
    const messageId = document.getElementById('acceptCooperationBtn').dataset.messageId;
    const ideaTitle = sessionStorage.getItem('ideaTitle');
    const ideaDescription = sessionStorage.getItem('ideaDescription');

    if (!messageId) {
      alert('شناسه پیام یافت نشد');
      return;
    }

    const response = await fetch('/api/accept-cooperation', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      },
      body: JSON.stringify({
        messageId: messageId,
        ideaTitle: ideaTitle,
        ideaDescription: ideaDescription
      })
    });

    if (response.ok) {
      alert('همکاری با موفقیت پذیرفته شد');
      // قفل کردن دکمه
      document.getElementById('acceptCooperationBtn').style.display = 'none';
      document.getElementById('lockedBtn').textContent = '✅ همکاری پذیرفته شده';
      document.getElementById('lockedBtn').style.display = 'inline-block';
    } else {
      const error = await response.json();
      alert('خطا در پذیرش همکاری: ' + error.error);
    }

  } catch (error) {
    console.error('خطا در پذیرش همکاری:', error);
    alert('خطا در پذیرش همکاری');
  }
}


// بررسی وضعیت دکمه
async function checkButtonStatus() {
  try {
    const ideaTitle = sessionStorage.getItem("ideaTitle");
    const targetBrandId = sessionStorage.getItem("targetBrandId");
    
    if (!ideaTitle || !targetBrandId) return;
    
    const response = await fetch(`/api/cooperation-requests/check/${encodeURIComponent(ideaTitle)}/${targetBrandId}`, {
      credentials: 'include'
    });
    
    if (response.ok) {
      const status = await response.json();
      const button = document.getElementById('btnCooperation');
      
      // ذخیره شناسه درخواست دریافتی
      if (status.receivedRequestId) {
        sessionStorage.setItem('receivedRequestId', status.receivedRequestId);
      }
      
      if (status.receivedRequestStatus === 'accepted') {
        // درخواست قبلاً پذیرفته شده
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-check"></i> درخواست پذیرفته شد';
        button.style.background = '#28a745';
      } else if (status.sentRequestStatus === 'pending') {
        // درخواست قبلاً ارسال شده
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-paper-plane"></i> درخواست ارسال شد';
        button.style.background = '#6c757d';
      } else if (status.sentRequestStatus === 'accepted') {
        // درخواست قبلاً پذیرفته شده
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-check"></i> درخواست پذیرفته شد';
        button.style.background = '#28a745';
      }
    }
  } catch (error) {
    console.error('خطا در بررسی وضعیت دکمه:', error);
  }
}

window.onload = async () => {
  // نمایش اطلاعات ایده
  await displayIdeaInfo();
  
  // بررسی وضعیت دکمه
  await checkButtonStatus();
  
  // دریافت targetBrandId از sessionStorage
  let targetBrandId = sessionStorage.getItem("targetBrandId");
  console.log("🔍 Debug - targetBrandId from sessionStorage:", targetBrandId);
  console.log("🔍 Debug - current URL:", window.location.href);
  console.log("🔍 Debug - search params:", window.location.search);
  
  // اگر targetBrandId در sessionStorage نیست، آن را از URL دریافت کن و ذخیره کن
  if (!targetBrandId) {
    targetBrandId = getTargetBrandId();
    console.log("🔍 Debug - targetBrandId from URL:", targetBrandId);
    if (targetBrandId) {
      sessionStorage.setItem("targetBrandId", targetBrandId);
      console.log("✅ targetBrandId from URL saved to sessionStorage:", targetBrandId);
    }
  }
  
  // اگر هنوز targetBrandId نداریم، پیام خطا نمایش بده
  if (!targetBrandId) {
    const analysisDiv = document.getElementById("analysis");
    analysisDiv.innerHTML = `
      <div style="color: #e74c3c; background: #fdf2f2; padding: 15px; border-radius: 8px; border: 1px solid #fecaca;">
        <h4 style="margin: 0 0 10px 0;">❌ خطا در بارگذاری</h4>
        <p style="margin: 0;">شناسه برند هدف یافت نشد. لطفاً ابتدا از صفحه فرصت‌های همکاری یک ایده را انتخاب کنید.</p>
        <button onclick="window.history.back()" style="margin-top: 10px; padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
          🔙 بازگشت
        </button>
      </div>
    `;
    return;
  }
  
  // بارگذاری تحلیل ایده
  await loadIdeaAnalysis();
  
  // بررسی وضعیت همکاری
  await checkCooperationStatus();
};

// نمایش اطلاعات ایده
async function displayIdeaInfo() {
  const ideaTitle = sessionStorage.getItem("ideaTitle") || "عنوان ایده";
  const ideaDescription = sessionStorage.getItem("ideaDescription") || "توضیحات ایده";
  const partnerName = sessionStorage.getItem("partnerName") || "برند همکار";
  
  // اگر نام برند همکار در sessionStorage نیست، آن را از API دریافت کن
  if (partnerName === "برند همکار") {
    try {
      const targetBrandId = sessionStorage.getItem("targetBrandId");
      if (targetBrandId) {
        const response = await fetch(`/api/brand/${targetBrandId}`, { credentials: 'include' });
        if (response.ok) {
          const targetBrand = await response.json();
          sessionStorage.setItem("partnerName", targetBrand.name);
          document.getElementById("partnerNameDisplay").textContent = targetBrand.name;
        }
      }
    } catch (error) {
      console.error("خطا در دریافت اطلاعات برند همکار:", error);
    }
  } else {
    document.getElementById("partnerNameDisplay").textContent = partnerName;
  }
  
  document.getElementById("ideaTitleDisplay").textContent = ideaTitle;
  document.getElementById("ideaDescriptionDisplay").textContent = ideaDescription;
  
  // به‌روزرسانی عنوان صفحه
  document.getElementById("pageTitle").textContent = `تحلیل حرفه‌ای ایده: ${ideaTitle}`;
}
</script>
</body>
</html>
