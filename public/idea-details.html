<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø¬Ø²Ø¦ÛŒØ§Øª Ø§ÛŒØ¯Ù‡ Ù‡Ù…Ú©Ø§Ø±ÛŒ</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');

    body {
      font-family: 'Vazirmatn', sans-serif;
      background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 50%, #ffffff 100%);
      padding: 20px;
      color: #333;
      line-height: 1.9;
      min-height: 100vh;
      margin: 0;
    }

    .container {
      max-width: 950px;
      margin: 0 auto;
    }

    /* Ø§Ø³ØªØ§ÛŒÙ„ Ù‡Ø¯Ø± */
    .header {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color: white;
      padding: 20px 30px;
      border-radius: 15px;
      margin-bottom: 30px;
      box-shadow: 0 8px 25px rgba(52, 152, 219, 0.3);
      position: relative;
      overflow: hidden;
      animation: headerSlideIn 0.8s ease-out;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    @keyframes headerSlideIn {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 100%);
      pointer-events: none;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      z-index: 1;
    }

    .header-title {
      font-size: 24px;
      font-weight: 700;
      margin: 0;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .header-nav {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .nav-link {
      color: white;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: 40px;
      padding: 0 18px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      position: relative;
      overflow: hidden;
      cursor: pointer;
      white-space: nowrap;
    }

    .nav-link::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .nav-link:hover::before {
      left: 100%;
    }

    .nav-link:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    /* Ø§Ø³ØªØ§ÛŒÙ„ Ù…Ø®ØµÙˆØµ Ø¯Ú©Ù…Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ - Ø¨Ù†ÙØ´ */
    .nav-dashboard {
      background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%) !important;
      border: 1px solid rgba(155, 89, 182, 0.3) !important;
    }

    .nav-dashboard:hover {
      background: linear-gradient(135deg, #8e44ad 0%, #7d3c98 100%) !important;
      box-shadow: 0 5px 15px rgba(155, 89, 182, 0.4) !important;
    }

    /* Ø§Ø³ØªØ§ÛŒÙ„ Ù…Ø®ØµÙˆØµ Ø¯Ú©Ù…Ù‡ Ù„ÛŒØ³Øª Ø¨Ø±Ù†Ø¯Ù‡Ø§ - Ø³ÙÛŒØ¯ Ø¨Ø§ Ù…ØªÙ† Ø¢Ø¨ÛŒ */
    .nav-brands {
      background: white !important;
      color: #3498db !important;
      border: 1px solid rgba(52, 152, 219, 0.3) !important;
    }

    .nav-brands:hover {
      background: #f8f9fa !important;
      color: #2980b9 !important;
      box-shadow: 0 5px 15px rgba(52, 152, 219, 0.2) !important;
    }

    /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¯Ú©Ù…Ù‡ Ø¨Ø±Ú¯Ø´Øª - Ù†Ø§Ø±Ù†Ø¬ÛŒ */
    .nav-back {
      background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%) !important;
      border: 1px solid rgba(243, 156, 18, 0.3) !important;
    }

    .nav-back:hover {
      background: linear-gradient(135deg, #e67e22 0%, #d35400 100%) !important;
      box-shadow: 0 5px 15px rgba(243, 156, 18, 0.4) !important;
    }

    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
      
      .header-nav {
        justify-content: center;
        flex-wrap: wrap;
      }
      
      .nav-link {
        padding: 10px 16px;
        font-size: 13px;
      }
    }

    h1 {
      text-align: center;
      border-bottom: 3px solid #3498db;
      padding-bottom: 10px;
      margin-bottom: 30px;
      color: #2c3e50;
    }

    .section {
      background: #fff;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.05);
    }

    .section h2 {
      color: #0057a3;
      font-size: 20px;
      margin-bottom: 15px;
    }

    .section h3 {
      color: #1f3b73;
      font-size: 18px;
      margin: 20px 0 10px;
    }

    .analysis-text {
      font-size: 16px;
      color: #444;
      margin-bottom: 15px;
    }

    .impact-list {
      list-style-type: disc;
      padding-right: 20px;
      font-size: 16px;
      color: #333;
    }

    .btn {
      background: #3498db;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: bold;
      margin: 10px 5px 0 0;
      cursor: pointer;
      transition: 0.3s;
      font-family: 'Vazirmatn', sans-serif;
    }

    .btn:hover { 
      background: #217dbb; 
    }

    .btn-success {
      background: #27ae60;
    }

    .btn-success:hover {
      background: #229954;
    }

    .btn-danger {
      background: #e74c3c;
    }

    .btn-danger:hover {
      background: #c0392b;
    }

    .btn-warning {
      background: #f39c12;
    }

    .btn-warning:hover {
      background: #e67e22;
    }

    .btn-disabled {
      background: #95a5a6;
      cursor: not-allowed;
    }

    .btn-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 20px;
    }

    .collaboration-section {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border: 2px solid #dee2e6;
      border-radius: 12px;
      padding: 25px;
      margin-top: 30px;
      margin-bottom: 25px;
    }

    .collaboration-section h2 {
      color: #495057;
      margin-bottom: 15px;
    }

    .status-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      margin-left: 10px;
    }

    .status-pending {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .status-accepted {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status-sent {
      background: #cce5ff;
      color: #004085;
      border: 1px solid #b3d7ff;
    }

    .idea-info {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #dee2e6;
    }

    .idea-info h3 {
      margin: 0 0 10px 0;
      color: #2c3e50;
    }

    .idea-info p {
      margin: 5px 0;
      color: #555;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #7f8c8d;
    }

    .error {
      background: #fdf2f2;
      border: 1px solid #fecaca;
      color: #e74c3c;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }

    .success {
      background: #f0f9ff;
      border: 1px solid #bae6fd;
      color: #0369a1;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }

    /* App Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 20px;
    }
    .modal-box {
      width: 100%;
      max-width: 520px;
      background: #ffffff;
      border-radius: 14px;
      box-shadow: 0 20px 50px rgba(2, 6, 23, 0.35);
      border: 1px solid #e2e8f0;
      overflow: hidden;
      animation: modalIn 0.18s ease-out;
    }
    @keyframes modalIn { from { opacity: 0; transform: translateY(8px);} to {opacity:1; transform: translateY(0);} }
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 14px 16px;
      background: linear-gradient(135deg, #eff6ff 0%, #ffffff 100%);
      border-bottom: 1px solid #e2e8f0;
    }
    .modal-title {
      margin: 0;
      font-size: 16px;
      font-weight: 800;
      color: #1e3a8a;
    }
    .modal-close {
      background: #eff6ff;
      border: 1px solid #dbeafe;
      width: 32px;
      height: 32px;
      border-radius: 8px;
      cursor: pointer;
      color: #1e40af;
      font-weight: 800;
    }
    .modal-body {
      padding: 16px;
      color: #334155;
      line-height: 1.9;
    }
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      padding: 12px 16px 16px 16px;
    }
    .modal-button {
      background: #2563eb;
      color: #fff;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
    }

    /* Analysis (CSR/PR/Branding) Styling */
    .analysis-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
      margin-top: 12px;
    }
    .analysis-card {
      background: #ffffff;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.06);
    }
    .analysis-card h3 {
      margin: 0 0 12px 0;
      font-size: 16px;
      color: #1e3a8a;
      border-right: 4px solid #3b82f6;
      padding-right: 10px;
    }
    .analysis-card ul {
      padding-right: 18px;
      margin: 0;
      color: #334155;
      line-height: 1.8;
    }

    /* Revenue Models Styling */
    .revenue-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 25px;
      margin-top: 20px;
    }

    #revenueModelsSection {
      margin-top: 40px;
    }

    @media (max-width: 768px) {
      .revenue-container {
        grid-template-columns: 1fr;
      }
    }

    .revenue-brand-box {
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    }

    .revenue-brand-title {
      font-size: 20px;
      font-weight: 700;
      color: #1e3a8a;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 3px solid #3b82f6;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .revenue-model-item {
      background: #ffffff;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 12px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .revenue-model-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
      border-color: #3b82f6;
    }

    .revenue-model-number {
      display: inline-block;
      background: linear-gradient(135deg, #3b82f6 0%, #1e3a8a 100%);
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      text-align: center;
      line-height: 28px;
      font-weight: 700;
      font-size: 14px;
      margin-left: 10px;
      float: right;
    }

    .revenue-model-text {
      margin-right: 40px;
      line-height: 1.7;
      color: #334155;
    }

    .model-title-box {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 10px 12px;
      margin: 8px 0 12px 0;
      font-weight: 700;
      color: #0f172a;
    }

    .model-section-title {
      font-weight: 700;
      color: #1e3a8a;
      margin: 8px 0 6px 0;
      font-size: 14px;
    }
  </style>
</head>
<body>

<div class="container">
  <!-- Ù‡Ø¯Ø± ØµÙØ­Ù‡ -->
  <header class="header">
    <div class="header-content">
      <h1 class="header-title" id="pageTitle">ğŸ’¡ Ø¬Ø²Ø¦ÛŒØ§Øª Ø§ÛŒØ¯Ù‡ Ù‡Ù…Ú©Ø§Ø±ÛŒ</h1>
      <nav class="header-nav">
        <a href="dashboard.html" class="nav-link nav-dashboard">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</a>
        <a href="brands.html" class="nav-link nav-brands">Ù„ÛŒØ³Øª Ø¨Ø±Ù†Ø¯Ù‡Ø§</a>
        <span onclick="window.history.back()" class="nav-link nav-back">â†© Ø¨Ø±Ú¯Ø´Øª</span>
      </nav>
    </div>
  </header>

  <!-- Idea Information Section -->
  <div class="section idea-info" id="ideaInfoSection">
  <h3>ğŸ“‹ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ÛŒØ¯Ù‡</h3>
  <div id="ideaInfo">
    <p><strong>Ø¹Ù†ÙˆØ§Ù† Ø§ÛŒØ¯Ù‡:</strong> <span id="ideaTitleDisplay">-</span></p>
    <p><strong>Ø¨Ø±Ù†Ø¯ Ù‡Ù…Ú©Ø§Ø±:</strong> <span id="partnerNameDisplay">-</span></p>
    <p><strong>ØªÙˆØ¶ÛŒØ­Ø§Øª:</strong> <span id="ideaDescriptionDisplay">-</span></p>
  </div>
</div>

<div class="section">
  <h2>Ú†Ø±Ø§ Ø¨Ø§ÛŒØ¯ Ø§ÛŒÙ† Ø§ÛŒØ¯Ù‡ Ø±Ø§ Ø§Ø² Ø²Ø§ÙˆÛŒÙ‡ CSRØŒ PR Ùˆ Branding Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø±Ø¯ØŸ</h2>
  <div id="analysis" class="analysis-text">â³ Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª ØªØ­Ù„ÛŒÙ„...</div>
</div>

<div class="btn-container">
  <button class="btn" id="btnSample">ğŸ“Œ Ù†Ù…ÙˆÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø¬Ø±Ø§ Ø´Ø¯Ù‡</button>
  <button class="btn" id="btnRevenue">ğŸ’° Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ø¯Ø±Ø¢Ù…Ø¯ÛŒ</button>
  <button class="btn" id="btnEconomy">ğŸ“Š ØªÙˆØ¬ÛŒÙ‡ Ø§Ù‚ØªØµØ§Ø¯ÛŒ</button>
  <button class="btn" id="btnStrategy">ğŸ“ˆ ÛŒÚ© Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡Ù…</button>
</div>

<!-- Revenue Models Section -->
<div class="section" id="revenueModelsSection" style="display:none;">
  <h2>ğŸ’° Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ø¯Ø±Ø¢Ù…Ø¯ÛŒ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ</h2>
  <div id="revenueModels" class="analysis-text">â€”</div>
  <div id="revenueError" class="error" style="display:none;"></div>
  <div id="revenueSuccess" class="success" style="display:none;"></div>
</div>

<!-- Collaboration Status Section -->
<div class="collaboration-section" id="collaborationSection">
  <h2>ğŸ¤ ÙˆØ¶Ø¹ÛŒØª Ù‡Ù…Ú©Ø§Ø±ÛŒ</h2>
  <div id="collaborationStatus">
    <div class="loading">â³ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª...</div>
  </div>
  <div id="collaborationButtons" style="margin-top: 20px; text-align: center;">
    <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù‡Ù…Ú©Ø§Ø±ÛŒ Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
  </div>
</div>

</div><!-- Ù¾Ø§ÛŒØ§Ù† container -->

<!-- Modal -->
<div id="appModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal-box">
    <div class="modal-header">
      <h4 class="modal-title" id="appModalTitle">Ø§Ø·Ù„Ø§Ø¹</h4>
      <button class="modal-close" id="appModalClose" aria-label="Ø¨Ø³ØªÙ†">Ã—</button>
    </div>
    <div class="modal-body" id="appModalBody">Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ ÙØ¹Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
    <div class="modal-actions">
      <button class="modal-button" id="appModalOk">Ø¨Ø§Ø´Ù‡</button>
    </div>
  </div>
  
</div>

<script>
let currentIdeaId = null;
let collaborationStatus = null;

// Ø¯Ø±ÛŒØ§ÙØª Ø´Ù†Ø§Ø³Ù‡ Ø§ÛŒØ¯Ù‡ Ø§Ø² URL ÛŒØ§ sessionStorage
function getIdeaId() {
  const params = new URLSearchParams(window.location.search);
  const ideaId = params.get("id");
  
  if (ideaId) {
    return ideaId;
  }
  
  // Ø§Ú¯Ø± ID Ø¯Ø± URL Ù†ÛŒØ³ØªØŒ Ø§Ø² sessionStorage Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†
  return sessionStorage.getItem("ideaId");
}

// Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø§ÛŒØ¯Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¹Ù†ÙˆØ§Ù† Ùˆ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø±Ù†Ø¯
async function findIdeaByTitle() {
  try {
    const ideaTitle = sessionStorage.getItem("ideaTitle");
    const targetBrandId = sessionStorage.getItem("targetBrandId");
    
    if (!ideaTitle || !targetBrandId) {
      throw new Error("Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ÛŒØ¯Ù‡ Ù†Ø§Ù‚Øµ Ø§Ø³Øª");
    }
    
    // Ø¯Ø±ÛŒØ§ÙØª Ø¨Ø±Ù†Ø¯ Ø®ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø±
    const myBrandResponse = await fetch("/api/my-brand", {
      credentials: 'include'
    });
    
    if (!myBrandResponse.ok) {
      throw new Error("Ø¨Ø±Ù†Ø¯ Ø´Ù…Ø§ ÛŒØ§ÙØª Ù†Ø´Ø¯");
    }
    
    const myBrand = await myBrandResponse.json();
    
    // Ø¬Ø³ØªØ¬ÙˆÛŒ Ø§ÛŒØ¯Ù‡ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³
    const ideasResponse = await fetch(`/api/ideas/partner/${targetBrandId}`, {
      credentials: 'include'
    });
    
    if (!ideasResponse.ok) {
      throw new Error("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§ÛŒØ¯Ù‡â€ŒÙ‡Ø§");
    }
    
    const ideas = await ideasResponse.json();
    
    // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø§ÛŒØ¯Ù‡ Ø¨Ø§ Ø¹Ù†ÙˆØ§Ù† Ù…Ø·Ø§Ø¨Ù‚
    const matchingIdea = ideas.find(idea => 
      idea.title === ideaTitle && 
      (idea.myBrandId._id === myBrand._id || idea.partnerBrandId._id === myBrand._id)
    );
    
    if (matchingIdea) {
      return matchingIdea._id;
    }
    
    // Ø§Ú¯Ø± Ø§ÛŒØ¯Ù‡ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ØŒ ÛŒÚ© Ø§ÛŒØ¯Ù‡ Ø¬Ø¯ÛŒØ¯ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†
    return await createNewIdea(ideaTitle, sessionStorage.getItem("ideaDescription"), targetBrandId);
    
  } catch (error) {
    console.error("Ø®Ø·Ø§ Ø¯Ø± Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø§ÛŒØ¯Ù‡:", error);
    throw error;
  }
}

// Ø§ÛŒØ¬Ø§Ø¯ Ø§ÛŒØ¯Ù‡ Ø¬Ø¯ÛŒØ¯
async function createNewIdea(title, description, partnerBrandId) {
  try {
    const response = await fetch('/api/ideas', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      credentials: 'include',
      body: JSON.stringify({
        title: title,
        description: description,
        partnerBrandId: partnerBrandId
      })
    });
    
    if (!response.ok) {
      throw new Error("Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø§ÛŒØ¯Ù‡ Ø¬Ø¯ÛŒØ¯");
    }
    
    const result = await response.json();
    return result.idea._id;
    
  } catch (error) {
    console.error("Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø§ÛŒØ¯Ù‡ Ø¬Ø¯ÛŒØ¯:", error);
    throw error;
  }
}

// Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ÛŒØ¯Ù‡
async function fetchIdeaDetails(ideaId) {
  try {
    console.log('ğŸ” Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ÛŒØ¯Ù‡ Ø¨Ø§ ID:', ideaId);
    const response = await fetch(`/api/ideas/${ideaId}`, {
      credentials: 'include'
    });
    
    console.log('ğŸ” Ù¾Ø§Ø³Ø® API:', response.status, response.statusText);
    
    if (!response.ok) {
      const errorData = await response.json();
      console.error('ğŸ” Ø®Ø·Ø§ÛŒ API:', errorData);
      throw new Error(errorData.error || 'Ø§ÛŒØ¯Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯');
    }
    
    const idea = await response.json();
    console.log('ğŸ” Ø§ÛŒØ¯Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯Ù‡:', idea);
    return idea;
  } catch (error) {
    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ÛŒØ¯Ù‡:', error);
    throw error;
  }
}

// Ø¯Ø±ÛŒØ§ÙØª ÙˆØ¶Ø¹ÛŒØª Ù‡Ù…Ú©Ø§Ø±ÛŒ
async function fetchCollaborationStatus(ideaId) {
  try {
    const response = await fetch(`/api/ideas/${ideaId}/collaboration-status`, {
      credentials: 'include'
    });
    
    if (!response.ok) {
      throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ÙˆØ¶Ø¹ÛŒØª Ù‡Ù…Ú©Ø§Ø±ÛŒ');
    }
    
    return await response.json();
  } catch (error) {
    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ÙˆØ¶Ø¹ÛŒØª Ù‡Ù…Ú©Ø§Ø±ÛŒ:', error);
    throw error;
  }
}

// Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ÛŒØ¯Ù‡
function displayIdeaInfo(idea) {
  document.getElementById("ideaTitleDisplay").textContent = idea.title;
  document.getElementById("ideaDescriptionDisplay").textContent = idea.description;
}

// Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª Ù‡Ù…Ú©Ø§Ø±ÛŒ
function displayCollaborationStatus(status) {
  const statusDiv = document.getElementById("collaborationStatus");
  const buttonsDiv = document.getElementById("collaborationButtons");
  
  let statusText = '';
  let statusClass = '';
  
  if (status.hasSentRequest) {
    if (status.sentRequestStatus === 'pending') {
      statusText = 'Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ù…Ú©Ø§Ø±ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡ - Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ù¾Ø§Ø³Ø®';
      statusClass = 'status-sent';
    } else if (status.sentRequestStatus === 'accepted') {
      statusText = 'Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ù…Ú©Ø§Ø±ÛŒ Ù¾Ø°ÛŒØ±ÙØªÙ‡ Ø´Ø¯Ù‡';
      statusClass = 'status-accepted';
    }
  } else if (status.hasReceivedRequest) {
    if (status.receivedRequestStatus === 'pending') {
      statusText = 'Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ù…Ú©Ø§Ø±ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯Ù‡ - Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ù¾Ø§Ø³Ø® Ø´Ù…Ø§';
      statusClass = 'status-pending';
    } else if (status.receivedRequestStatus === 'accepted') {
      statusText = 'Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ù…Ú©Ø§Ø±ÛŒ Ù¾Ø°ÛŒØ±ÙØªÙ‡ Ø´Ø¯Ù‡';
      statusClass = 'status-accepted';
    }
  } else {
    statusText = 'Ù‡ÛŒÚ† Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ù…Ú©Ø§Ø±ÛŒ Ø§Ø±Ø³Ø§Ù„ Ù†Ø´Ø¯Ù‡';
    statusClass = 'status-pending';
  }
  
  statusDiv.innerHTML = `
    <div class="status-badge ${statusClass}">${statusText}</div>
  `;
  
  // Ù†Ù…Ø§ÛŒØ´ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ù†Ø§Ø³Ø¨
  buttonsDiv.innerHTML = '';
  
  // Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± ØµØ§Ø­Ø¨ Ø§ÛŒØ¯Ù‡ Ø§Ø³Øª (isOwner = true)
  if (status.isOwner) {
    if (status.canSendRequest) {
      // Ú©Ø§Ø±Ø¨Ø± ØµØ§Ø­Ø¨ Ø§ÛŒØ¯Ù‡ Ø§Ø³Øª Ùˆ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø±Ø³Ø§Ù„ Ú©Ù†Ø¯
      const sendBtn = document.createElement('button');
      sendBtn.className = 'btn btn-success';
      sendBtn.textContent = 'ğŸ¤ Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ù…Ú©Ø§Ø±ÛŒ';
      sendBtn.onclick = () => sendCollaborationRequest();
      buttonsDiv.appendChild(sendBtn);
    } else if (status.hasSentRequest && status.sentRequestStatus === 'pending') {
      // Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡ Ùˆ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ù¾Ø§Ø³Ø®
      const waitingBtn = document.createElement('button');
      waitingBtn.className = 'btn btn-disabled';
      waitingBtn.textContent = 'â³ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ù¾Ø§Ø³Ø®';
      waitingBtn.disabled = true;
      buttonsDiv.appendChild(waitingBtn);
    } else if (status.hasSentRequest && status.sentRequestStatus === 'accepted') {
      // Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù¾Ø°ÛŒØ±ÙØªÙ‡ Ø´Ø¯Ù‡
      const acceptedBtn = document.createElement('button');
      acceptedBtn.className = 'btn btn-disabled';
      acceptedBtn.textContent = 'âœ… Ù‡Ù…Ú©Ø§Ø±ÛŒ Ù¾Ø°ÛŒØ±ÙØªÙ‡ Ø´Ø¯Ù‡';
      acceptedBtn.disabled = true;
      buttonsDiv.appendChild(acceptedBtn);
    }
  } 
  // Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†Ù†Ø¯Ù‡ Ø§Ø³Øª (isPartner = true)
  else if (status.isPartner) {
    if (status.canAcceptRequest) {
      // Ú©Ø§Ø±Ø¨Ø± Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†Ù†Ø¯Ù‡ Ø§Ø³Øª Ùˆ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø±Ø§ Ø¨Ù¾Ø°ÛŒØ±Ø¯
      const acceptBtn = document.createElement('button');
      acceptBtn.className = 'btn btn-danger';
      acceptBtn.textContent = 'âœ… Ù¾Ø°ÛŒØ±ÙØªÙ† Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ù…Ú©Ø§Ø±ÛŒ';
      acceptBtn.onclick = () => acceptCollaborationRequest(status.receivedRequestId);
      buttonsDiv.appendChild(acceptBtn);
    } else if (status.hasReceivedRequest && status.receivedRequestStatus === 'accepted') {
      // Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø±ÛŒØ§ÙØªÛŒ Ù¾Ø°ÛŒØ±ÙØªÙ‡ Ø´Ø¯Ù‡
      const acceptedBtn = document.createElement('button');
      acceptedBtn.className = 'btn btn-disabled';
      acceptedBtn.textContent = 'âœ… Ù‡Ù…Ú©Ø§Ø±ÛŒ Ù¾Ø°ÛŒØ±ÙØªÙ‡ Ø´Ø¯Ù‡';
      acceptedBtn.disabled = true;
      buttonsDiv.appendChild(acceptedBtn);
    }
  }
}

// Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ù…Ú©Ø§Ø±ÛŒ
async function sendCollaborationRequest() {
  // Ù†Ù…Ø§ÛŒØ´ Ù¾Ø§Ù¾â€ŒØ¢Ù¾ ØªØ§ÛŒÛŒØ¯
  const confirmed = confirm('Ø¢ÛŒØ§ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ù…Ú©Ø§Ø±ÛŒ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ');
  if (!confirmed) {
    return; // Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ù„ØºÙˆ Ú©Ø±Ø¯ØŒ Ú©Ø§Ø±ÛŒ Ø§Ù†Ø¬Ø§Ù… Ù†Ø¯Ù‡
  }

  try {
    const response = await fetch('/api/cooperation-requests', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      credentials: 'include',
      body: JSON.stringify({
        targetBrandId: collaborationStatus.isOwner ? 
          (await fetchIdeaDetails(currentIdeaId)).partnerBrandId : 
          (await fetchIdeaDetails(currentIdeaId)).myBrandId,
        ideaTitle: collaborationStatus.ideaTitle,
        ideaDescription: collaborationStatus.ideaDescription
      })
    });

    if (response.ok) {
      alert('âœ… Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ù…Ú©Ø§Ø±ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯');
      // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª
      await loadCollaborationStatus();
    } else {
      const error = await response.json();
      alert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª: ' + error.error);
    }
  } catch (error) {
    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ù…Ú©Ø§Ø±ÛŒ:', error);
    alert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ù…Ú©Ø§Ø±ÛŒ');
  }
}

// Ù¾Ø°ÛŒØ±ÙØªÙ† Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ù…Ú©Ø§Ø±ÛŒ
async function acceptCollaborationRequest(requestId) {
  // Ù†Ù…Ø§ÛŒØ´ Ù¾Ø§Ù¾â€ŒØ¢Ù¾ ØªØ§ÛŒÛŒØ¯
  const confirmed = confirm('Ø¢ÛŒØ§ Ø§Ø² Ù¾Ø°ÛŒØ±Ø´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ù…Ú©Ø§Ø±ÛŒ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ');
  if (!confirmed) {
    return; // Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ù„ØºÙˆ Ú©Ø±Ø¯ØŒ Ú©Ø§Ø±ÛŒ Ø§Ù†Ø¬Ø§Ù… Ù†Ø¯Ù‡
  }

  try {
    const response = await fetch(`/api/cooperation-requests/${requestId}/accept`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      credentials: 'include'
    });

    if (response.ok) {
      alert('âœ… Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ù…Ú©Ø§Ø±ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾Ø°ÛŒØ±ÙØªÙ‡ Ø´Ø¯');
      // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª
      await loadCollaborationStatus();
    } else {
      const error = await response.json();
      alert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø°ÛŒØ±Ø´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª: ' + error.error);
    }
  } catch (error) {
    console.error('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø°ÛŒØ±Ø´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ù…Ú©Ø§Ø±ÛŒ:', error);
    alert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø°ÛŒØ±Ø´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ù…Ú©Ø§Ø±ÛŒ');
  }
}

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙˆØ¶Ø¹ÛŒØª Ù‡Ù…Ú©Ø§Ø±ÛŒ
async function loadCollaborationStatus() {
  try {
    const status = await fetchCollaborationStatus(currentIdeaId);
    collaborationStatus = status;
    displayCollaborationStatus(status);
  } catch (error) {
    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙˆØ¶Ø¹ÛŒØª Ù‡Ù…Ú©Ø§Ø±ÛŒ:', error);
    document.getElementById("collaborationStatus").innerHTML = 
      '<div class="error">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙˆØ¶Ø¹ÛŒØª Ù‡Ù…Ú©Ø§Ø±ÛŒ</div>';
  }
}

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØ­Ù„ÛŒÙ„ Ø§ÛŒØ¯Ù‡
async function loadIdeaAnalysis() {
  try {
    const idea = await fetchIdeaDetails(currentIdeaId);

    // Ø°Ø®ÛŒØ±Ù‡ Ø³Ø±ÛŒØ¹ Ø§ÛŒØ¯Ù‡ Ø¯Ø± Ø³Ø´Ù†
    if (!sessionStorage.getItem("ideaPrompt")) {
      sessionStorage.setItem("ideaPrompt", idea.title + '\n\n' + idea.description);
      sessionStorage.setItem("ideaTitle", idea.title);
      sessionStorage.setItem("ideaDescription", idea.description);
    }

    const analysisDiv = document.getElementById("analysis");
    analysisDiv.textContent = "â³ Ø¯Ø± Ø­Ø§Ù„ ØªØ­Ù„ÛŒÙ„...";

    // Ø³Ø§Ø®Øª Ù¾Ø±Ø§Ù…Ù¾Øª Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ: 3 Ù…ÙˆØ±Ø¯ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ù…Ù†Ø¸Ø± (CSR/PR/Branding)
    const csrPrBrandPrompt = `
Ø´Ø±Ø­ Ø§ÛŒØ¯Ù‡ Ù‡Ù…Ú©Ø§Ø±ÛŒ:
Ø¹Ù†ÙˆØ§Ù†: ${idea.title}
ØªÙˆØ¶ÛŒØ­: ${idea.description}

ÙˆØ¸ÛŒÙÙ‡ ØªÙˆ: ÙÙ‚Ø· Ùˆ ÙÙ‚Ø· Â«Ú†Ø±Ø§ÛŒÛŒÂ»â€ŒÙ‡Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ† Ø§ÛŒØ¯Ù‡ Ø§Ø² Ø³Ù‡ Ù…Ù†Ø¸Ø± Ø²ÛŒØ± Ø±Ø§ Ø¨ÛŒØ§Ù† Ú©Ù†Ø› ÛŒØ¹Ù†ÛŒ Ø¯Ù„Ø§ÛŒÙ„ØŒ Ù…Ù†Ø·Ù‚ Ùˆ Ø§Ø±Ø²Ø´â€ŒÙ‡Ø§ÛŒ Ù†Ù‡ÙØªÙ‡ Ú©Ù‡ Ù†Ø´Ø§Ù† Ø¯Ù‡Ø¯ Ú†Ø±Ø§ Ù†Ú¯Ø§Ù‡ Ø§Ø² Ø§ÛŒÙ† Ø²Ø§ÙˆÛŒÙ‡ Ø¶Ø±ÙˆØ±ÛŒ/Ù…ÙÛŒØ¯/Ø§Ø«Ø±Ú¯Ø°Ø§Ø± Ø§Ø³Øª. Ù‡ÛŒÚ† Ø±Ø§Ù‡Ú©Ø§Ø± Ø§Ø¬Ø±Ø§ÛŒÛŒØŒ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø¹Ù…Ù„ÛŒØ§ØªÛŒØŒ ÛŒØ§ Ø§ÛŒØ¯Ù‡â€ŒÛŒ Ø¬Ø¯ÛŒØ¯ Ø§Ø±Ø§Ø¦Ù‡ Ù†Ø¯Ù‡. Ø§Ø² Ø§ÙØ¹Ø§Ù„ Ø¯Ø³ØªÙˆØ±ÛŒ (Ù…Ø«Ù„ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯/Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ú©Ù†ÛŒØ¯) Ù¾Ø±Ù‡ÛŒØ² Ú©Ù†. Ù‡Ø± Ù…ÙˆØ±Ø¯ Û±â€“Û² Ø¬Ù…Ù„Ù‡ØŒ Ø´ÙØ§ÙØŒ Ø¯Ù‚ÛŒÙ‚ Ùˆ Ø¨Ø¯ÙˆÙ† Ú©Ù„ÛŒâ€ŒÚ¯ÙˆÛŒÛŒ Ø¨Ø§Ø´Ø¯.

ÙØ±Ù…Øª Ø®Ø±ÙˆØ¬ÛŒ Ø§Ø¬Ø¨Ø§Ø±ÛŒ (Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ù‡Ù…ÛŒÙ† Ø³Ø§Ø®ØªØ§Ø±):
CSR:
1) ...
2) ...
3) ...

PR:
1) ...
2) ...
3) ...

Branding:
1) ...
2) ...
3) ...`;

    const response = await fetch("/api/generate-ideas", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ 
        prompt: csrPrBrandPrompt,
        myBrandId: typeof idea.myBrandId === 'object' ? idea.myBrandId._id : idea.myBrandId,
        targetBrandId: typeof idea.partnerBrandId === 'object' ? idea.partnerBrandId._id : idea.partnerBrandId
      })
    });

    if (response.ok) {
      const data = await response.json();
      const content = (data.choices?.[0]?.message?.content || '').trim();

      // Ù¾Ø§Ø±Ø³ Ù¾Ø§Ø³Ø® Ø¨Ø± Ø§Ø³Ø§Ø³ ÙØ±Ù…Øª Ø§Ø¬Ø¨Ø§Ø±ÛŒ
      const extractSection = (name) => {
        const regex = new RegExp(`${name}:[\\s\\S]*?(?=(CSR:|PR:|Branding:|$))`, 'i');
        const match = content.match(regex);
        if (!match) return [];
        const section = match[0]
          .replace(/^[^\n]*\n?/, '')
          .split('\n')
          .map(l => l.trim())
          .filter(l => l)
          .map(l => l.replace(/^\d+[\)\.\-]\s*/, ''))
          .slice(0, 3);
        return section;
      };

      const csrItems = extractSection('CSR');
      const prItems = extractSection('PR');
      const brandItems = extractSection('Branding');

      const cardHTML = (title, items) => `
        <div class="analysis-card">
          <h3>${title}</h3>
          <ul>
            ${items.map(it => `<li>${it}</li>`).join('')}
          </ul>
        </div>
      `;

      analysisDiv.innerHTML = `
        <div class="analysis-cards">
          ${cardHTML('Ø§Ø² Ù…Ù†Ø¸Ø± Ù…Ø³Ø¦ÙˆÙ„ÛŒØª Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ (CSR)', csrItems)}
          ${cardHTML('Ø§Ø² Ù…Ù†Ø¸Ø± Ø±ÙˆØ§Ø¨Ø· Ø¹Ù…ÙˆÙ…ÛŒ (PR)', prItems)}
          ${cardHTML('Ø§Ø² Ù†Ú¯Ø§Ù‡ Ø¨Ø±Ù†Ø¯Ø³Ø§Ø²ÛŒ (Branding)', brandItems)}
        </div>
      `;
    } else {
      analysisDiv.innerHTML = `
        <div class="error">
          <h4>âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØ­Ù„ÛŒÙ„ Ø§ÛŒØ¯Ù‡</h4>
          <p>Ù…ØªØ£Ø³ÙØ§Ù†Ù‡ Ø§Ù…Ú©Ø§Ù† ØªØ­Ù„ÛŒÙ„ Ø§ÛŒØ¯Ù‡ Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</p>
        </div>
      `;
    }
  } catch (error) {
    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØ­Ù„ÛŒÙ„ Ø§ÛŒØ¯Ù‡:', error);
    document.getElementById("analysis").innerHTML = `
      <div class="error">
        <h4>âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØ­Ù„ÛŒÙ„ Ø§ÛŒØ¯Ù‡</h4>
        <p>${error.message}</p>
      </div>
    `;
  }
}

// ØªÙˆÙ„ÛŒØ¯ Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ø¯Ø±Ø¢Ù…Ø¯ÛŒ Ø¨Ø§ OpenAI Ùˆ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± ØµÙØ­Ù‡
async function generateRevenueModels() {
  try {
    const section = document.getElementById('revenueModelsSection');
    const out = document.getElementById('revenueModels');
    const errBox = document.getElementById('revenueError');
    const okBox = document.getElementById('revenueSuccess');

    section.style.display = 'block';
    errBox.style.display = 'none';
    okBox.style.display = 'none';
    out.innerHTML = 'â³ Ø¯Ø± Ø­Ø§Ù„ ØªÙˆÙ„ÛŒØ¯ Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ø¯Ø±Ø¢Ù…Ø¯ÛŒ...';

    // Ø¯Ø±ÛŒØ§ÙØª Ø§ÛŒØ¯Ù‡ Ùˆ Ø¨Ø±Ù†Ø¯Ù‡Ø§ Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®Øª Ù¾Ø±Ø§Ù…Ù¾Øª
    const idea = await fetchIdeaDetails(currentIdeaId);

    // Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ùˆ Ø¨Ø±Ù†Ø¯ Ø¯Ø±Ú¯ÛŒØ± Ø¨Ø§ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø´Ù†Ø§Ø³Ù‡â€ŒÙ‡Ø§ÛŒ Ø±Ø´ØªÙ‡â€ŒØ§ÛŒ
    const myBrandResp = await fetch('/api/my-brand', { credentials: 'include' });
    const myBrand = myBrandResp.ok ? await myBrandResp.json() : null;

    const ideaMyId = typeof idea.myBrandId === 'object' ? (idea.myBrandId._id || idea.myBrandId.id) : idea.myBrandId;
    const ideaPartnerId = typeof idea.partnerBrandId === 'object' ? (idea.partnerBrandId._id || idea.partnerBrandId.id) : idea.partnerBrandId;

    const isOwner = myBrand && ideaMyId && myBrand._id === ideaMyId;
    const otherBrandId = isOwner ? ideaPartnerId : ideaMyId;

    const partnerResp = otherBrandId ? await fetch(`/api/brand/${otherBrandId}`, { credentials: 'include' }) : null;
    const targetBrand = partnerResp && partnerResp.ok ? await partnerResp.json() : null;

    // Ø³Ø§Ø®Øª enhancedPrompt Ø§Ø² Ø¹Ù†ÙˆØ§Ù† + ØªÙˆØ¶ÛŒØ­Ø§Øª Ø§ÛŒØ¯Ù‡
    const enhancedPrompt = `${idea.title}\n\n${idea.description || ''}`.trim();

    const promptBrand1Name = myBrand ? myBrand.name : (typeof idea.myBrandId === 'object' ? idea.myBrandId?.name : 'Ø¨Ø±Ù†Ø¯ Ø§ÙˆÙ„');
    const promptBrand2Name = targetBrand ? targetBrand.name : (typeof idea.partnerBrandId === 'object' ? idea.partnerBrandId?.name : 'Ø¨Ø±Ù†Ø¯ Ø¯ÙˆÙ…');

    const revenuePrompt = `
ØªÙˆ ÛŒÚ© Ù†Ø§Ø¨ØºÙ‡ Ú©Ø³Ø¨â€ŒÙˆÚ©Ø§Ø± Ùˆ Ù…Ø´Ø§ÙˆØ± Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒÚ© Ø¨Ø±Ù†Ø¯ Ø¯Ø± Ø³Ø·Ø­ Ø¬Ù‡Ø§Ù†ÛŒ Ù‡Ø³ØªÛŒØŒ Ú©Ø³ÛŒ Ú©Ù‡ ØªØ¬Ø±Ø¨Ù‡ Ø®Ù„Ù‚ Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ø¯Ø±Ø¢Ù…Ø¯ÛŒ Ù…ÛŒÙ„ÛŒØ§Ø±Ø¯ Ø¯Ù„Ø§Ø±ÛŒ Ùˆ ÙÙˆÙ‚â€ŒØ§Ù„Ø¹Ø§Ø¯Ù‡ Ø®Ù„Ø§Ù‚Ø§Ù†Ù‡ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ù†Ø¯Ù‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù Ø±Ø§ Ø¯Ø§Ø±Ø¯.  
Ù‡Ø¯Ù ØªÙˆ Ø§ÛŒÙ† Ø§Ø³Øª Ú©Ù‡ Ø§Ø² Ø§ÛŒØ¯Ù‡ Ù‡Ù…Ú©Ø§Ø±ÛŒ Ø²ÛŒØ±ØŒ **5 Ù…Ø¯Ù„ Ø¯Ø±Ø¢Ù…Ø¯ÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ùˆ Ú©Ø§Ù…Ù„Ø§Ù‹ Ø¹Ù…Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ù†Ø¯ Ø§ÙˆÙ„ Ùˆ 5 Ù…Ø¯Ù„ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ù†Ø¯ Ø¯ÙˆÙ…** Ø¨Ø³Ø§Ø²ÛŒ.  

Ø§ÛŒØ¯Ù‡ Ù‡Ù…Ú©Ø§Ø±ÛŒ: ${enhancedPrompt}

**Ù†Ú©Ø§Øª Ù…Ù‡Ù… Ø¨Ø±Ø§ÛŒ ØªÙˆÙ„ÛŒØ¯ Ù…Ø¯Ù„â€ŒÙ‡Ø§:**  
- Ù…Ø¯Ù„â€ŒÙ‡Ø§ Ø¨Ø§ÛŒØ¯ Ú©Ø§Ù…Ù„Ø§Ù‹ Ø®Ù„Ø§Ù‚Ø§Ù†Ù‡ØŒ Ù†ÙˆØ¢ÙˆØ±Ø§Ù†Ù‡ Ùˆ Ù…Ù†Ø­ØµØ± Ø¨Ù‡ ÙØ±Ø¯ Ø¨Ø§Ø´Ù†Ø¯.  
- Ù…Ø¯Ù„â€ŒÙ‡Ø§ Ø¨Ø§ÛŒØ¯ Ø¹Ù…Ù„ÛŒ Ùˆ Ù‚Ø§Ø¨Ù„ Ø§Ø¬Ø±Ø§ Ø¨Ø§Ø´Ù†Ø¯ØŒ Ø¨Ø¯ÙˆÙ† Ø§Ø±Ø§Ø¦Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø®Ø´Ú© ÛŒØ§ Ø¬Ø¯ÙˆÙ„â€ŒØ¨Ù†Ø¯ÛŒ Ø±Ø³Ù…ÛŒ.  
- ØªÙˆØ¶ÛŒØ­Ø§Øª Ù‡Ø± Ù…Ø¯Ù„ Ø¨Ø§ÛŒØ¯ **Ø¬Ø²Ø¦ÛŒØ§Øª Ø¯Ù‚ÛŒÙ‚ØŒ Ù…Ø«Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø¯ÛŒ Ùˆ Ù†Ø­ÙˆÙ‡ Ø¯Ø±Ø¢Ù…Ø¯Ø²Ø§ÛŒÛŒ** Ø±Ø§ Ù†Ø´Ø§Ù† Ø¯Ù‡Ø¯.  
- Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒ Ø§Ø² Ø§Ù†ÙˆØ§Ø¹ Ù…Ø¯Ù„â€ŒÙ‡Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒ: ÙØ±ÙˆØ´ Ù…Ø³ØªÙ‚ÛŒÙ…ØŒ Ø§Ø´ØªØ±Ø§Ú©ØŒ Ø§Ø³Ù¾Ø§Ù†Ø³Ø±Ø´ÛŒÙ¾ØŒ Ø®Ø¯Ù…Ø§Øª ÙˆÛŒÚ˜Ù‡ØŒ Ø¢Ù¾â€ŒØ³Ù„ØŒ ØªØ¨Ù„ÛŒØºØ§ØªØŒ Ù„ÛŒØ¯ Ø¬Ù†ØŒ Ø¨Ø³ØªÙ‡â€ŒÙ‡Ø§ÛŒ B2B Ùˆ Ù‡Ø± Ø±ÙˆØ´ Ø¯ÛŒÚ¯Ø±ÛŒ Ú©Ù‡ Ø®Ù„Ø§Ù‚Ø§Ù†Ù‡ Ùˆ Ø³ÙˆØ¯Ø¢ÙˆØ± Ø¨Ø§Ø´Ø¯.  
- Ø³Ø¨Ú© Ù†ÙˆØ´ØªØ§Ø± Ø¨Ø§ÛŒØ¯ **Ù…Ø«Ù„ Ù…Ø´Ø§ÙˆØ± Ù…ÛŒÙ„ÛŒØ§Ø±Ø¯ Ø¯Ù„Ø§Ø±ÛŒ** Ø¨Ø§Ø´Ø¯ØŒ Ø·Ø¨ÛŒØ¹ÛŒØŒ Ø±ÙˆØ§Ù† Ùˆ Ø¨Ø§ ØªÙ…Ø§Ù… Ø¬Ø²Ø¦ÛŒØ§Øª Ù„Ø§Ø²Ù… Ø¨Ø±Ø§ÛŒ Ø¯Ø±Ú© Ø§Ø±Ø²Ø´ Ù…Ø¯Ù„.  

**Ø¨Ø±Ø§ÛŒ ${promptBrand1Name}:**  
1. [Ø¹Ù†ÙˆØ§Ù† Ù…Ø¯Ù„] â€” Ø´Ø±Ø­ Ú©ÙˆØªØ§Ù‡ Ù…Ø¯Ù„ (Û²â€“Û³ Ø¬Ù…Ù„Ù‡). Ø¬Ø²Ø¦ÛŒØ§Øª Ø¹Ù…Ù„ÛŒ: ... | Ù†Ø­ÙˆÙ‡ Ø¯Ø±Ø¢Ù…Ø¯Ø²Ø§ÛŒÛŒ: ... | Ù…Ø«Ø§Ù„: ...  
2. [Ù…Ø¯Ù„ Ø¯Ø±Ø¢Ù…Ø¯ÛŒ Ø¯ÙˆÙ…...]  
3. [Ù…Ø¯Ù„ Ø¯Ø±Ø¢Ù…Ø¯ÛŒ Ø³ÙˆÙ…...]  
4. [Ù…Ø¯Ù„ Ø¯Ø±Ø¢Ù…Ø¯ÛŒ Ú†Ù‡Ø§Ø±Ù…...]  
5. [Ù…Ø¯Ù„ Ø¯Ø±Ø¢Ù…Ø¯ÛŒ Ù¾Ù†Ø¬Ù…...]  

**Ø¨Ø±Ø§ÛŒ ${promptBrand2Name}:**  
1. [Ø¹Ù†ÙˆØ§Ù† Ù…Ø¯Ù„] â€” Ø´Ø±Ø­ Ú©ÙˆØªØ§Ù‡ Ù…Ø¯Ù„ (Û²â€“Û³ Ø¬Ù…Ù„Ù‡). Ø¬Ø²Ø¦ÛŒØ§Øª Ø¹Ù…Ù„ÛŒ: ... | Ù†Ø­ÙˆÙ‡ Ø¯Ø±Ø¢Ù…Ø¯Ø²Ø§ÛŒÛŒ: ... | Ù…Ø«Ø§Ù„: ...  
2. [Ù…Ø¯Ù„ Ø¯Ø±Ø¢Ù…Ø¯ÛŒ Ø¯ÙˆÙ…...]  
3. [Ù…Ø¯Ù„ Ø¯Ø±Ø¢Ù…Ø¯ÛŒ Ø³ÙˆÙ…...]  
4. [Ù…Ø¯Ù„ Ø¯Ø±Ø¢Ù…Ø¯ÛŒ Ú†Ù‡Ø§Ø±Ù…...]  
5. [Ù…Ø¯Ù„ Ø¯Ø±Ø¢Ù…Ø¯ÛŒ Ù¾Ù†Ø¬Ù…...]  

**ØªØ°Ú©Ø±:**  
- Ù‡ÛŒÚ† Ù…Ø¯Ù„ Ù†Ø¨Ø§ÛŒØ¯ Ø´Ø¨ÛŒÙ‡ Ø¯ÛŒÚ¯Ø±ÛŒ Ø¨Ø§Ø´Ø¯ØŒ ØªÙ…Ø§Ù… Ù…Ø¯Ù„â€ŒÙ‡Ø§ Ø¨Ø§ÛŒØ¯ Ø®Ù„Ø§Ù‚Ø§Ù†Ù‡ØŒ Ù…ØªÙ…Ø§ÛŒØ² Ùˆ Ø¬Ø°Ø§Ø¨ Ø¨Ø§Ø´Ù†Ø¯.  
- ØªÙˆØ¶ÛŒØ­Ø§Øª Ø¨Ø§ÛŒØ¯ ÙˆØ§Ù‚Ø¹ÛŒ Ùˆ Ù‚Ø§Ø¨Ù„ ØªØµÙˆØ± Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§ÛŒ Ø¹Ù…Ù„ÛŒ Ø¨Ø§Ø´Ù†Ø¯ØŒ Ù†Ù‡ Ú©Ù„ÛŒ Ùˆ Ø³Ø·Ø­ÛŒ.  
- ØªÙ…Ø±Ú©Ø² Ø±ÙˆÛŒ Ø³ÙˆØ¯Ø¢ÙˆØ±ÛŒØŒ Ù†ÙˆØ¢ÙˆØ±ÛŒ Ùˆ Ø¹Ù…Ù„ÛŒ Ø¨ÙˆØ¯Ù† Ù…Ø¯Ù„â€ŒÙ‡Ø§ Ø¨Ø§Ø´Ø¯.  
- Ø³Ø¨Ú© Ù†ÙˆØ´ØªØ§Ø± Ø¨Ø§ÛŒØ¯ **Ø¬Ø°Ø§Ø¨ØŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ùˆ Ø¨Ù‡ Ú¯ÙˆÙ†Ù‡â€ŒØ§ÛŒ Ø¨Ø§Ø´Ø¯ Ú©Ù‡ Ø®ÙˆØ§Ù†Ù†Ø¯Ù‡ Ø§Ø­Ø³Ø§Ø³ Ú©Ù†Ø¯ ÛŒÚ© Ù…Ø´Ø§ÙˆØ± Ø¨Ø±Ù†Ø¯ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ùˆ Ø¨Ø§ ØªØ¬Ø±Ø¨Ù‡ Ø¢Ù† Ø±Ø§ Ù†ÙˆØ´ØªÙ‡ Ø§Ø³Øª.**
 
ÙØ±Ù…Øª Ø®Ø±ÙˆØ¬ÛŒ Ø§Ø¬Ø¨Ø§Ø±ÛŒ (Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ù‡Ù…ÛŒÙ† Ø³Ø§Ø®ØªØ§Ø± Ø±Ø§ Ø±Ø¹Ø§ÛŒØª Ú©Ù†):
Ø¨Ø±Ø§ÛŒ ${promptBrand1Name}:
1. ...
2. ...
3. ...
4. ...
5. ...

Ø¨Ø±Ø§ÛŒ ${promptBrand2Name}:
1. ...
2. ...
3. ...
4. ...
5. ...
`;

    const resp = await fetch('/api/generate-ideas', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        prompt: revenuePrompt, 
        myBrandId: isOwner ? ideaMyId : otherBrandId,
        targetBrandId: isOwner ? otherBrandId : ideaMyId
      })
    });

    if (!resp.ok) {
      const e = await resp.json().catch(() => ({}));
      throw new Error(e.error || 'Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ø¯Ø±Ø¢Ù…Ø¯ÛŒ');
    }

    const data = await resp.json();
    const content = data.choices?.[0]?.message?.content || '';

    // Ù¾Ø§Ø±Ø³ Ú©Ø±Ø¯Ù† Ø®Ø±ÙˆØ¬ÛŒ Ùˆ ØªÙÚ©ÛŒÚ© Ø¯Ùˆ Ø¨Ø®Ø´ Ø¨Ø±Ù†Ø¯ (Ø­ÙØ¸ ØªÙˆØ¶ÛŒØ­Ø§Øª Ú†Ù†Ø¯Ø®Ø·ÛŒ)
    const persianDigits = {'Û°':'0','Û±':'1','Û²':'2','Û³':'3','Û´':'4','Ûµ':'5','Û¶':'6','Û·':'7','Û¸':'8','Û¹':'9'};
    const normalizeDigits = (str) => (str || '').replace(/[Û°-Û¹]/g, d => persianDigits[d] || d);

    const lines = content.split('\n').map(l => l.trim()).filter(Boolean);
    
    let brand1Name = promptBrand1Name || myBrand?.name || 'Ø¨Ø±Ù†Ø¯ Ø§ÙˆÙ„';
    let brand2Name = promptBrand2Name || targetBrand?.name || 'Ø¨Ø±Ù†Ø¯ Ø¯ÙˆÙ…';
    let brand1Models = [];
    let brand2Models = [];
    let currentBrand = null;

    const numberRegex = /^(?:\d+|[Û°-Û¹]+)[\.:\)\-\s]+/; // 1. ÛŒØ§ Û±) ÛŒØ§ 1- ...
    const isBrandHeader = (line) => {
      const lower = normalizeDigits(line).toLowerCase();
      if (/^\s*Ø¨Ø±Ø§ÛŒ\s+/.test(lower)) {
        if (lower.includes(brand1Name.toLowerCase()) || lower.includes('Ø¨Ø±Ù†Ø¯ Ø§ÙˆÙ„') || lower.includes('Ø§ÙˆÙ„')) return 1;
        if (lower.includes(brand2Name.toLowerCase()) || lower.includes('Ø¨Ø±Ù†Ø¯ Ø¯ÙˆÙ…') || lower.includes('Ø¯ÙˆÙ…')) return 2;
      }
      return 0;
    };
    const isNumbered = (line) => numberRegex.test(normalizeDigits(line));

    for (let i = 0; i < lines.length; i++) {
      const line = lines[i];
      const header = isBrandHeader(line);
      if (header === 1) { currentBrand = 1; continue; }
      if (header === 2) { currentBrand = 2; continue; }
      if (isNumbered(line)) {
        // Ø¢ØºØ§Ø² ÛŒÚ© Ù…Ø¯Ù„ Ø¬Ø¯ÛŒØ¯Ø› ØªÙˆØ¶ÛŒØ­Ø§Øª ØªØ§ Ù‚Ø¨Ù„ Ø§Ø² Ù…Ø¯Ù„ Ø´Ù…Ø§Ø±Ù‡â€ŒØ¯Ø§Ø± Ø¨Ø¹Ø¯ÛŒ ÛŒØ§ Ù‡Ø¯Ø± Ø¨Ø±Ù†Ø¯ Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ø´ÙˆØ¯
        let text = line.replace(numberRegex, '').trim();
        let j = i + 1;
        while (j < lines.length && !isNumbered(lines[j]) && isBrandHeader(lines[j]) === 0) {
          text += '\n' + lines[j];
          j++;
        }
        if (currentBrand === 1) brand1Models.push(text);
        else if (currentBrand === 2) brand2Models.push(text);
        i = j - 1;
      }
    }

    // ØªÙ„Ø§Ø´ Ø¯ÙˆÙ… (fallback): Ø§Ú¯Ø± Ú†ÛŒØ²ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ØŒ Ø§Ø² Ù‡Ù…Ù‡ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§Ø±Ù‡â€ŒØ¯Ø§Ø± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ùˆ Ø¨ÛŒÙ† Ø¯Ùˆ Ø¨Ø±Ù†Ø¯ ØªÙ‚Ø³ÛŒÙ… Ú©Ù†
    if (brand1Models.length === 0 && brand2Models.length === 0) {
      const allModels = [];
      for (let i = 0; i < lines.length; i++) {
        if (isNumbered(lines[i])) {
          let text = lines[i].replace(numberRegex, '').trim();
          let j = i + 1;
          while (j < lines.length && !isNumbered(lines[j]) && isBrandHeader(lines[j]) === 0) {
            text += '\n' + lines[j];
            j++;
          }
          allModels.push(text);
          i = j - 1;
        }
      }
      if (allModels.length > 0) {
        brand1Models = allModels.slice(0, 5);
        brand2Models = allModels.slice(5, 10);
      }
    }

    // Ø³Ø§Ø®Øª HTML Ø´ÛŒÚ© Ùˆ Ú©Ø§Ø¯Ø±Ø¨Ù†Ø¯ÛŒ Ø´Ø¯Ù‡
    // Ù…Ø¯Ù„â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù†/Ø´Ø±Ø­/Ø¬Ø²Ø¦ÛŒØ§Øª Ø¹Ù…Ù„ÛŒ/Ø¯Ø±Ø¢Ù…Ø¯Ø²Ø§ÛŒÛŒ/Ù…Ø«Ø§Ù„ ØªÙÚ©ÛŒÚ© Ú©Ù† (Ø¨Ø§ Ø§Ù„Ú¯ÙˆÙ‡Ø§ÛŒ Ø³Ø§Ø¯Ù‡)
    function parseModelText(text) {
      const parts = { title: '', desc: '', ops: '', revenue: '', example: '' };
      const lines = text.split('\n').map(l => l.trim()).filter(Boolean);
      if (lines.length > 0) {
        parts.title = lines[0];
        parts.desc = lines.slice(1).join(' ');
      }
      // ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø³Ú©Ø´Ù†â€ŒÙ‡Ø§ Ø¯Ø§Ø®Ù„ desc
      const extract = (labelFa, key) => {
        const regex = new RegExp(`${labelFa}\s*[:ï¼š-]\s*([^|]+)`, 'i');
        const m = parts.desc.match(regex);
        if (m) { parts[key] = m[1].trim(); parts.desc = parts.desc.replace(m[0], '').trim(); }
      };
      extract('Ø¬Ø²Ø¦ÛŒØ§Øª Ø¹Ù…Ù„ÛŒ', 'ops');
      extract('Ù†Ø­ÙˆÙ‡ Ø¯Ø±Ø¢Ù…Ø¯Ø²Ø§ÛŒÛŒ', 'revenue');
      extract('Ù…Ø«Ø§Ù„', 'example');
      return parts;
    }

    const renderModel = (model, idx) => {
      const p = parseModelText(model);
      return `
        <div class="revenue-model-item">
          <span class="revenue-model-number">${idx + 1}</span>
          <div class="revenue-model-text">
            <div class="model-title-box">${p.title || 'Ù…Ø¯Ù„ Ø¯Ø±Ø¢Ù…Ø¯ÛŒ'}</div>
            ${p.desc ? `<div class="model-section-title">Ø´Ø±Ø­</div><div>${p.desc}</div>` : ''}
            ${p.ops ? `<div class="model-section-title">Ø¬Ø²Ø¦ÛŒØ§Øª Ø¹Ù…Ù„ÛŒ</div><div>${p.ops}</div>` : ''}
            ${p.revenue ? `<div class="model-section-title">Ù†Ø­ÙˆÙ‡ Ø¯Ø±Ø¢Ù…Ø¯Ø²Ø§ÛŒÛŒ</div><div>${p.revenue}</div>` : ''}
            ${p.example ? `<div class="model-section-title">Ù…Ø«Ø§Ù„</div><div>${p.example}</div>` : ''}
          </div>
        </div>
      `;
    };

    const brand1HTML = brand1Models.map((m, i) => renderModel(m, i)).join('');
    const brand2HTML = brand2Models.map((m, i) => renderModel(m, i)).join('');

    // Ø§Ú¯Ø± Ù‡ÛŒÚ† Ù…Ø¯Ù„ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯ØŒ Ù¾ÛŒØ§Ù… Ù…Ù†Ø§Ø³Ø¨ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡ Ùˆ success Ù†Ø´Ø§Ù† Ø¯Ø§Ø¯Ù‡ Ù†Ø´ÙˆØ¯
    if (brand1Models.length === 0 && brand2Models.length === 0) {
      out.innerHTML = '<p style="color:#999;">Ù…Ø¯Ù„ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ù¾Ø±Ø§Ù…Ù¾Øª Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.</p>';
      return;
    }

    out.innerHTML = `
      <div class="revenue-container">
        <div class="revenue-brand-box">
          <div class="revenue-brand-title">ğŸ’¼ ${brand1Name}</div>
          ${brand1HTML || '<p style="color:#999;">Ù…Ø¯Ù„ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</p>'}
        </div>
        <div class="revenue-brand-box">
          <div class="revenue-brand-title">ğŸ’¼ ${brand2Name}</div>
          ${brand2HTML || '<p style="color:#999;">Ù…Ø¯Ù„ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</p>'}
        </div>
      </div>
    `;
    
    okBox.textContent = 'âœ… Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ø¯Ø±Ø¢Ù…Ø¯ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯';
    okBox.style.display = 'block';
  } catch (err) {
    console.error('Revenue models error:', err);
    const errBox = document.getElementById('revenueError');
    const section = document.getElementById('revenueModelsSection');
    section.style.display = 'block';
    errBox.textContent = err.message || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ø¯Ø±Ø¢Ù…Ø¯ÛŒ';
    errBox.style.display = 'block';
  }
}

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø±Ù†Ø¯ Ù‡Ù…Ú©Ø§Ø±
async function loadPartnerInfo(idea) {
  try {
    // Ø¯Ø±ÛŒØ§ÙØª Ø¨Ø±Ù†Ø¯ Ø®ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø±
    const myBrandResp = await fetch('/api/my-brand', { credentials: 'include' });
    const myBrand = myBrandResp.ok ? await myBrandResp.json() : null;

    const ideaMyId = typeof idea.myBrandId === 'object' ? (idea.myBrandId._id || idea.myBrandId.id) : idea.myBrandId;
    const ideaPartnerId = typeof idea.partnerBrandId === 'object' ? (idea.partnerBrandId._id || idea.partnerBrandId.id) : idea.partnerBrandId;

    let otherBrandId = ideaPartnerId;
    if (myBrand && myBrand._id && ideaMyId && myBrand._id === ideaMyId) {
      otherBrandId = ideaPartnerId;
    } else {
      otherBrandId = ideaMyId;
    }

    if (!otherBrandId) throw new Error('Ø´Ù†Ø§Ø³Ù‡ Ø¨Ø±Ù†Ø¯ Ù‡Ù…Ú©Ø§Ø± Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');

    const response = await fetch(`/api/brand/${otherBrandId}`, { credentials: 'include' });
    if (response.ok) {
      const partnerBrand = await response.json();
      document.getElementById('partnerNameDisplay').textContent = partnerBrand.name;
    }
  } catch (error) {
    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø±Ù†Ø¯ Ù‡Ù…Ú©Ø§Ø±:', error);
    document.getElementById('partnerNameDisplay').textContent = 'Ø¨Ø±Ù†Ø¯ Ù‡Ù…Ú©Ø§Ø±';
  }
}

// Event Listeners
document.getElementById("btnSample").addEventListener("click", () => {
  openAppModal('ğŸ“Œ Ù†Ù…ÙˆÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø¬Ø±Ø§ Ø´Ø¯Ù‡', 'Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ ÙØ¹Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯.');
});

document.getElementById("btnRevenue").addEventListener("click", () => {
  generateRevenueModels();
});

document.getElementById("btnEconomy").addEventListener("click", () => {
  openAppModal('ğŸ“Š ØªÙˆØ¬ÛŒÙ‡ Ø§Ù‚ØªØµØ§Ø¯ÛŒ', 'Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ ÙØ¹Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯.');
});

document.getElementById("btnStrategy").addEventListener("click", () => {
  openAppModal('ğŸ“ˆ ÛŒÚ© Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡Ù…', 'Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ ÙØ¹Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯.');
});

// App Modal Helpers
function openAppModal(title, body) {
  const modal = document.getElementById('appModal');
  const titleEl = document.getElementById('appModalTitle');
  const bodyEl = document.getElementById('appModalBody');
  titleEl.textContent = title || 'Ø§Ø·Ù„Ø§Ø¹';
  bodyEl.textContent = body || '';
  modal.style.display = 'flex';
  document.body.style.overflow = 'hidden';
}

function closeAppModal() {
  const modal = document.getElementById('appModal');
  modal.style.display = 'none';
  document.body.style.overflow = '';
}

document.getElementById('appModalClose').addEventListener('click', closeAppModal);
document.getElementById('appModalOk').addEventListener('click', closeAppModal);
document.getElementById('appModal').addEventListener('click', (e) => {
  if (e.target.id === 'appModal') closeAppModal();
});
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeAppModal();
});

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ØµÙØ­Ù‡
window.onload = async () => {
  try {
    currentIdeaId = getIdeaId();
    console.log('ğŸ” currentIdeaId Ø§Ø² getIdeaId:', currentIdeaId);
    
    // Ø§Ú¯Ø± ID Ø¯Ø± URL ÛŒØ§ sessionStorage Ù†ÛŒØ³ØªØŒ Ø³Ø¹ÛŒ Ú©Ù† Ø¢Ù† Ø±Ø§ Ù¾ÛŒØ¯Ø§ Ú©Ù†
    if (!currentIdeaId) {
      try {
        console.log('ğŸ” Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ¯Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¹Ù†ÙˆØ§Ù†...');
        currentIdeaId = await findIdeaByTitle();
        sessionStorage.setItem("ideaId", currentIdeaId);
        console.log('ğŸ” Ø§ÛŒØ¯Ù‡ Ù¾ÛŒØ¯Ø§ Ø´Ø¯ Ø¨Ø§ ID:', currentIdeaId);
      } catch (error) {
        console.error("Ø®Ø·Ø§ Ø¯Ø± Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø§ÛŒØ¯Ù‡:", error);
        document.getElementById("analysis").innerHTML = `
          <div class="error">
            <h4>âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</h4>
            <p>Ø§ÛŒØ¯Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ø·Ø±ÛŒÙ‚ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.</p>
            <button onclick="window.location.href='dashboard.html'" class="btn">
              ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
            </button>
          </div>
        `;
        return;
      }
    }
    
    if (!currentIdeaId) {
      console.error('âŒ currentIdeaId Ù‡Ù†ÙˆØ² null Ø§Ø³Øª');
      document.getElementById("analysis").innerHTML = `
        <div class="error">
          <h4>âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</h4>
          <p>Ø´Ù†Ø§Ø³Ù‡ Ø§ÛŒØ¯Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ø·Ø±ÛŒÙ‚ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.</p>
          <button onclick="window.location.href='dashboard.html'" class="btn">
            ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
          </button>
        </div>
      `;
      return;
    }
    
    console.log('ğŸ” Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÛŒØ¯Ù‡ Ø¨Ø§ ID:', currentIdeaId);

    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ÛŒØ¯Ù‡
    const idea = await fetchIdeaDetails(currentIdeaId);
    displayIdeaInfo(idea);
    
    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙˆØ¶Ø¹ÛŒØª Ù‡Ù…Ú©Ø§Ø±ÛŒ
    await loadCollaborationStatus();
    
    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø±Ù†Ø¯ Ù‡Ù…Ú©Ø§Ø±
    await loadPartnerInfo(idea);
    
    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØ­Ù„ÛŒÙ„ Ø§ÛŒØ¯Ù‡
    await loadIdeaAnalysis();
    
  } catch (error) {
    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØµÙØ­Ù‡:', error);
    document.getElementById("analysis").innerHTML = `
      <div class="error">
        <h4>âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</h4>
        <p>${error.message}</p>
        <button onclick="window.location.href='dashboard.html'" class="btn">
          ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
        </button>
      </div>
    `;
  }
};
</script>
</body>
</html>