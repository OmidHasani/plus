<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>جزئیات ایده همکاری</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');

    body {
      font-family: 'Vazirmatn', sans-serif;
      background: #f4f6f9;
      max-width: 950px;
      margin: 40px auto;
      padding: 20px;
      color: #333;
      line-height: 1.9;
    }

    h1 {
      text-align: center;
      border-bottom: 3px solid #3498db;
      padding-bottom: 10px;
      margin-bottom: 30px;
      color: #2c3e50;
    }

    .section {
      background: #fff;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.05);
    }

    .section h2 {
      color: #0057a3;
      font-size: 20px;
      margin-bottom: 15px;
    }

    .section h3 {
      color: #1f3b73;
      font-size: 18px;
      margin: 20px 0 10px;
    }

    .analysis-text {
      font-size: 16px;
      color: #444;
      margin-bottom: 15px;
    }

    .impact-list {
      list-style-type: disc;
      padding-right: 20px;
      font-size: 16px;
      color: #333;
    }

    .btn {
      background: #3498db;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: bold;
      margin: 10px 5px 0 0;
      cursor: pointer;
      transition: 0.3s;
      font-family: 'Vazirmatn', sans-serif;
    }

    .btn:hover { 
      background: #217dbb; 
    }

    .btn-success {
      background: #27ae60;
    }

    .btn-success:hover {
      background: #229954;
    }

    .btn-danger {
      background: #e74c3c;
    }

    .btn-danger:hover {
      background: #c0392b;
    }

    .btn-warning {
      background: #f39c12;
    }

    .btn-warning:hover {
      background: #e67e22;
    }

    .btn-disabled {
      background: #95a5a6;
      cursor: not-allowed;
    }

    .btn-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 20px;
    }

    .collaboration-section {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border: 2px solid #dee2e6;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 25px;
    }

    .collaboration-section h2 {
      color: #495057;
      margin-bottom: 15px;
    }

    .status-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      margin-left: 10px;
    }

    .status-pending {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .status-accepted {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status-sent {
      background: #cce5ff;
      color: #004085;
      border: 1px solid #b3d7ff;
    }

    .idea-info {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #dee2e6;
    }

    .idea-info h3 {
      margin: 0 0 10px 0;
      color: #2c3e50;
    }

    .idea-info p {
      margin: 5px 0;
      color: #555;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #7f8c8d;
    }

    .error {
      background: #fdf2f2;
      border: 1px solid #fecaca;
      color: #e74c3c;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }

    .success {
      background: #f0f9ff;
      border: 1px solid #bae6fd;
      color: #0369a1;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }
  </style>
</head>
<body>

<h1 id="pageTitle">جزئیات ایده همکاری</h1>

<!-- Idea Information Section -->
<div class="section idea-info" id="ideaInfoSection">
  <h3>📋 اطلاعات ایده</h3>
  <div id="ideaInfo">
    <p><strong>عنوان ایده:</strong> <span id="ideaTitleDisplay">-</span></p>
    <p><strong>برند همکار:</strong> <span id="partnerNameDisplay">-</span></p>
    <p><strong>توضیحات:</strong> <span id="ideaDescriptionDisplay">-</span></p>
  </div>
</div>

<!-- Collaboration Status Section -->
<div class="collaboration-section" id="collaborationSection">
  <h2>🤝 وضعیت همکاری</h2>
  <div id="collaborationStatus">
    <div class="loading">⏳ در حال بررسی وضعیت...</div>
  </div>
  <div id="collaborationButtons" style="margin-top: 20px; text-align: center;">
    <!-- دکمه‌های همکاری در اینجا نمایش داده می‌شوند -->
  </div>
</div>

<div class="section">
  <h2>چرا باید این ایده را از زاویه CSR، PR و Branding بررسی کرد؟</h2>
  <div id="analysis" class="analysis-text">⏳ در حال دریافت تحلیل...</div>
</div>

<div class="btn-container">
  <button class="btn" id="btnSample">📌 نمونه‌های اجرا شده</button>
  <button class="btn" id="btnBenefits">🤝 مزایا برای طرفین</button>
  <button class="btn" id="btnRevenue">💰 مدل‌های درآمدی</button>
  <button class="btn" id="btnEconomy">📊 توجیه اقتصادی</button>
  <button class="btn" id="btnStrategy">📈 یک استراتژی می‌خواهم</button>
  <button class="btn" id="btnBack">🔙 بازگشت به داشبورد</button>
</div>

<script>
let currentIdeaId = null;
let collaborationStatus = null;

// دریافت شناسه ایده از URL یا sessionStorage
function getIdeaId() {
  const params = new URLSearchParams(window.location.search);
  const ideaId = params.get("id");
  
  if (ideaId) {
    return ideaId;
  }
  
  // اگر ID در URL نیست، از sessionStorage دریافت کن
  return sessionStorage.getItem("ideaId");
}

// پیدا کردن ایده بر اساس عنوان و اطلاعات برند
async function findIdeaByTitle() {
  try {
    const ideaTitle = sessionStorage.getItem("ideaTitle");
    const targetBrandId = sessionStorage.getItem("targetBrandId");
    
    if (!ideaTitle || !targetBrandId) {
      throw new Error("اطلاعات ایده ناقص است");
    }
    
    // دریافت برند خود کاربر
    const myBrandResponse = await fetch("/api/my-brand", {
      credentials: 'include'
    });
    
    if (!myBrandResponse.ok) {
      throw new Error("برند شما یافت نشد");
    }
    
    const myBrand = await myBrandResponse.json();
    
    // جستجوی ایده در دیتابیس
    const ideasResponse = await fetch(`/api/ideas/partner/${targetBrandId}`, {
      credentials: 'include'
    });
    
    if (!ideasResponse.ok) {
      throw new Error("خطا در دریافت ایده‌ها");
    }
    
    const ideas = await ideasResponse.json();
    
    // پیدا کردن ایده با عنوان مطابق
    const matchingIdea = ideas.find(idea => 
      idea.title === ideaTitle && 
      (idea.myBrandId._id === myBrand._id || idea.partnerBrandId._id === myBrand._id)
    );
    
    if (matchingIdea) {
      return matchingIdea._id;
    }
    
    // اگر ایده پیدا نشد، یک ایده جدید ایجاد کن
    return await createNewIdea(ideaTitle, sessionStorage.getItem("ideaDescription"), targetBrandId);
    
  } catch (error) {
    console.error("خطا در پیدا کردن ایده:", error);
    throw error;
  }
}

// ایجاد ایده جدید
async function createNewIdea(title, description, partnerBrandId) {
  try {
    const response = await fetch('/api/ideas', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      credentials: 'include',
      body: JSON.stringify({
        title: title,
        description: description,
        partnerBrandId: partnerBrandId
      })
    });
    
    if (!response.ok) {
      throw new Error("خطا در ایجاد ایده جدید");
    }
    
    const result = await response.json();
    return result.idea._id;
    
  } catch (error) {
    console.error("خطا در ایجاد ایده جدید:", error);
    throw error;
  }
}

// دریافت اطلاعات ایده
async function fetchIdeaDetails(ideaId) {
  try {
    console.log('🔍 در حال دریافت اطلاعات ایده با ID:', ideaId);
    const response = await fetch(`/api/ideas/${ideaId}`, {
      credentials: 'include'
    });
    
    console.log('🔍 پاسخ API:', response.status, response.statusText);
    
    if (!response.ok) {
      const errorData = await response.json();
      console.error('🔍 خطای API:', errorData);
      throw new Error(errorData.error || 'ایده یافت نشد');
    }
    
    const idea = await response.json();
    console.log('🔍 ایده دریافت شده:', idea);
    return idea;
  } catch (error) {
    console.error('خطا در دریافت اطلاعات ایده:', error);
    throw error;
  }
}

// دریافت وضعیت همکاری
async function fetchCollaborationStatus(ideaId) {
  try {
    const response = await fetch(`/api/ideas/${ideaId}/collaboration-status`, {
      credentials: 'include'
    });
    
    if (!response.ok) {
      throw new Error('خطا در دریافت وضعیت همکاری');
    }
    
    return await response.json();
  } catch (error) {
    console.error('خطا در دریافت وضعیت همکاری:', error);
    throw error;
  }
}

// نمایش اطلاعات ایده
function displayIdeaInfo(idea) {
  document.getElementById("ideaTitleDisplay").textContent = idea.title;
  document.getElementById("ideaDescriptionDisplay").textContent = idea.description;
  document.getElementById("pageTitle").textContent = `جزئیات ایده: ${idea.title}`;
}

// نمایش وضعیت همکاری
function displayCollaborationStatus(status) {
  const statusDiv = document.getElementById("collaborationStatus");
  const buttonsDiv = document.getElementById("collaborationButtons");
  
  let statusText = '';
  let statusClass = '';
  
  if (status.hasSentRequest) {
    if (status.sentRequestStatus === 'pending') {
      statusText = 'درخواست همکاری ارسال شده - در انتظار پاسخ';
      statusClass = 'status-sent';
    } else if (status.sentRequestStatus === 'accepted') {
      statusText = 'درخواست همکاری پذیرفته شده';
      statusClass = 'status-accepted';
    }
  } else if (status.hasReceivedRequest) {
    if (status.receivedRequestStatus === 'pending') {
      statusText = 'درخواست همکاری دریافت شده - در انتظار پاسخ شما';
      statusClass = 'status-pending';
    } else if (status.receivedRequestStatus === 'accepted') {
      statusText = 'درخواست همکاری پذیرفته شده';
      statusClass = 'status-accepted';
    }
  } else {
    statusText = 'هیچ درخواست همکاری ارسال نشده';
    statusClass = 'status-pending';
  }
  
  statusDiv.innerHTML = `
    <div class="status-badge ${statusClass}">${statusText}</div>
  `;
  
  // نمایش دکمه‌های مناسب
  buttonsDiv.innerHTML = '';
  
  // اگر کاربر صاحب ایده است (isOwner = true)
  if (status.isOwner) {
    if (status.canSendRequest) {
      // کاربر صاحب ایده است و می‌تواند درخواست ارسال کند
      const sendBtn = document.createElement('button');
      sendBtn.className = 'btn btn-success';
      sendBtn.textContent = '🤝 ارسال درخواست همکاری';
      sendBtn.onclick = () => sendCollaborationRequest();
      buttonsDiv.appendChild(sendBtn);
    } else if (status.hasSentRequest && status.sentRequestStatus === 'pending') {
      // درخواست ارسال شده و در انتظار پاسخ
      const waitingBtn = document.createElement('button');
      waitingBtn.className = 'btn btn-disabled';
      waitingBtn.textContent = '⏳ در انتظار پاسخ';
      waitingBtn.disabled = true;
      buttonsDiv.appendChild(waitingBtn);
    } else if (status.hasSentRequest && status.sentRequestStatus === 'accepted') {
      // درخواست پذیرفته شده
      const acceptedBtn = document.createElement('button');
      acceptedBtn.className = 'btn btn-disabled';
      acceptedBtn.textContent = '✅ همکاری پذیرفته شده';
      acceptedBtn.disabled = true;
      buttonsDiv.appendChild(acceptedBtn);
    }
  } 
  // اگر کاربر دریافت کننده است (isPartner = true)
  else if (status.isPartner) {
    if (status.canAcceptRequest) {
      // کاربر دریافت کننده است و می‌تواند درخواست را بپذیرد
      const acceptBtn = document.createElement('button');
      acceptBtn.className = 'btn btn-danger';
      acceptBtn.textContent = '✅ پذیرفتن درخواست همکاری';
      acceptBtn.onclick = () => acceptCollaborationRequest(status.receivedRequestId);
      buttonsDiv.appendChild(acceptBtn);
    } else if (status.hasReceivedRequest && status.receivedRequestStatus === 'accepted') {
      // درخواست دریافتی پذیرفته شده
      const acceptedBtn = document.createElement('button');
      acceptedBtn.className = 'btn btn-disabled';
      acceptedBtn.textContent = '✅ همکاری پذیرفته شده';
      acceptedBtn.disabled = true;
      buttonsDiv.appendChild(acceptedBtn);
    }
  }
}

// ارسال درخواست همکاری
async function sendCollaborationRequest() {
  try {
    const response = await fetch('/api/cooperation-requests', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      credentials: 'include',
      body: JSON.stringify({
        targetBrandId: collaborationStatus.isOwner ? 
          (await fetchIdeaDetails(currentIdeaId)).partnerBrandId : 
          (await fetchIdeaDetails(currentIdeaId)).myBrandId,
        ideaTitle: collaborationStatus.ideaTitle,
        ideaDescription: collaborationStatus.ideaDescription
      })
    });

    if (response.ok) {
      alert('درخواست همکاری با موفقیت ارسال شد');
      // بروزرسانی وضعیت
      await loadCollaborationStatus();
    } else {
      const error = await response.json();
      alert('خطا در ارسال درخواست: ' + error.error);
    }
  } catch (error) {
    console.error('خطا در ارسال درخواست همکاری:', error);
    alert('خطا در ارسال درخواست همکاری');
  }
}

// پذیرفتن درخواست همکاری
async function acceptCollaborationRequest(requestId) {
  try {
    const response = await fetch(`/api/cooperation-requests/${requestId}/accept`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      credentials: 'include'
    });

    if (response.ok) {
      alert('درخواست همکاری با موفقیت پذیرفته شد');
      // بروزرسانی وضعیت
      await loadCollaborationStatus();
    } else {
      const error = await response.json();
      alert('خطا در پذیرش درخواست: ' + error.error);
    }
  } catch (error) {
    console.error('خطا در پذیرش درخواست همکاری:', error);
    alert('خطا در پذیرش درخواست همکاری');
  }
}

// بارگذاری وضعیت همکاری
async function loadCollaborationStatus() {
  try {
    const status = await fetchCollaborationStatus(currentIdeaId);
    collaborationStatus = status;
    displayCollaborationStatus(status);
  } catch (error) {
    console.error('خطا در بارگذاری وضعیت همکاری:', error);
    document.getElementById("collaborationStatus").innerHTML = 
      '<div class="error">خطا در بارگذاری وضعیت همکاری</div>';
  }
}

// بارگذاری تحلیل ایده
async function loadIdeaAnalysis() {
  try {
    const idea = await fetchIdeaDetails(currentIdeaId);
    
    // اگر ایده‌ای در sessionStorage نیست، آن را ذخیره کن
    if (!sessionStorage.getItem("ideaPrompt")) {
      sessionStorage.setItem("ideaPrompt", idea.title + '\n\n' + idea.description);
      sessionStorage.setItem("ideaTitle", idea.title);
      sessionStorage.setItem("ideaDescription", idea.description);
    }

    const analysisDiv = document.getElementById("analysis");
    analysisDiv.textContent = "⏳ در حال تحلیل...";

    // فراخوانی API برای تحلیل
    const response = await fetch("/api/generate-ideas", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ 
        prompt: `بر اساس اطلاعات زیر:
${idea.title}

${idea.description}

یک تحلیل غنی و پرمحتوا (۴–۵ خط) بنویس که توضیح دهد چرا این ایده باید از زاویه‌های مسئولیت اجتماعی (CSR)، روابط عمومی (PR) و برندسازی (Branding) بررسی شود. این تحلیل باید عمیق و متقاعدکننده باشد و مزایای این همکاری را از هر سه زاویه به طور جامع پوشش دهد.

هیچ مقدمه یا نتیجه‌گیری اضافه ننویس. فقط همین تحلیل را بنویس.`,
        myBrandId: idea.myBrandId,
        targetBrandId: idea.partnerBrandId
      })
    });

    if (response.ok) {
      const data = await response.json();
      const analysis = data.choices[0].message.content;
      analysisDiv.innerHTML = analysis.replace(/\n/g, "<br>");
    } else {
      analysisDiv.innerHTML = `
        <div class="error">
          <h4>❌ خطا در تحلیل ایده</h4>
          <p>متأسفانه امکان تحلیل ایده در حال حاضر وجود ندارد.</p>
        </div>
      `;
    }
  } catch (error) {
    console.error('خطا در بارگذاری تحلیل ایده:', error);
    document.getElementById("analysis").innerHTML = `
      <div class="error">
        <h4>❌ خطا در تحلیل ایده</h4>
        <p>${error.message}</p>
      </div>
    `;
  }
}

// بارگذاری اطلاعات برند همکار
async function loadPartnerInfo(idea) {
  try {
    const partnerBrandId = idea.myBrandId.toString() === collaborationStatus?.isOwner ? 
      idea.partnerBrandId : idea.myBrandId;
    
    const response = await fetch(`/api/brand/${partnerBrandId}`, {
      credentials: 'include'
    });
    
    if (response.ok) {
      const partnerBrand = await response.json();
      document.getElementById("partnerNameDisplay").textContent = partnerBrand.name;
    }
  } catch (error) {
    console.error('خطا در دریافت اطلاعات برند همکار:', error);
    document.getElementById("partnerNameDisplay").textContent = 'برند همکار';
  }
}

// Event Listeners
document.getElementById("btnBack").addEventListener("click", () => {
  window.location.href = "dashboard.html";
});

document.getElementById("btnSample").addEventListener("click", () => {
  alert("📌 نمونه‌های اجرا شده به زودی فعال می‌شود");
});

document.getElementById("btnBenefits").addEventListener("click", () => {
  alert("🤝 مزایا برای طرفین به زودی فعال می‌شود");
});

document.getElementById("btnRevenue").addEventListener("click", () => {
  alert("💰 مدل‌های درآمدی به زودی فعال می‌شود");
});

document.getElementById("btnEconomy").addEventListener("click", () => {
  alert("📊 توجیه اقتصادی به زودی فعال می‌شود");
});

document.getElementById("btnStrategy").addEventListener("click", () => {
  alert("📈 استراتژی به زودی فعال می‌شود");
});

// بارگذاری اولیه صفحه
window.onload = async () => {
  try {
    currentIdeaId = getIdeaId();
    console.log('🔍 currentIdeaId از getIdeaId:', currentIdeaId);
    
    // اگر ID در URL یا sessionStorage نیست، سعی کن آن را پیدا کن
    if (!currentIdeaId) {
      try {
        console.log('🔍 جستجو برای ایده بر اساس عنوان...');
        currentIdeaId = await findIdeaByTitle();
        sessionStorage.setItem("ideaId", currentIdeaId);
        console.log('🔍 ایده پیدا شد با ID:', currentIdeaId);
      } catch (error) {
        console.error("خطا در پیدا کردن ایده:", error);
        document.getElementById("analysis").innerHTML = `
          <div class="error">
            <h4>❌ خطا در بارگذاری</h4>
            <p>ایده یافت نشد. لطفاً از طریق داشبورد وارد شوید.</p>
            <button onclick="window.location.href='dashboard.html'" class="btn">
              🔙 بازگشت به داشبورد
            </button>
          </div>
        `;
        return;
      }
    }
    
    if (!currentIdeaId) {
      console.error('❌ currentIdeaId هنوز null است');
      document.getElementById("analysis").innerHTML = `
        <div class="error">
          <h4>❌ خطا در بارگذاری</h4>
          <p>شناسه ایده یافت نشد. لطفاً از طریق داشبورد وارد شوید.</p>
          <button onclick="window.location.href='dashboard.html'" class="btn">
            🔙 بازگشت به داشبورد
          </button>
        </div>
      `;
      return;
    }
    
    console.log('🔍 در حال بارگذاری ایده با ID:', currentIdeaId);

    // بارگذاری اطلاعات ایده
    const idea = await fetchIdeaDetails(currentIdeaId);
    displayIdeaInfo(idea);
    
    // بارگذاری وضعیت همکاری
    await loadCollaborationStatus();
    
    // بارگذاری اطلاعات برند همکار
    await loadPartnerInfo(idea);
    
    // بارگذاری تحلیل ایده
    await loadIdeaAnalysis();
    
  } catch (error) {
    console.error('خطا در بارگذاری صفحه:', error);
    document.getElementById("analysis").innerHTML = `
      <div class="error">
        <h4>❌ خطا در بارگذاری</h4>
        <p>${error.message}</p>
        <button onclick="window.location.href='dashboard.html'" class="btn">
          🔙 بازگشت به داشبورد
        </button>
      </div>
    `;
  }
};
</script>
</body>
</html>