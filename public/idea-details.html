<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø¬Ø²Ø¦ÛŒØ§Øª Ø§ÛŒØ¯Ù‡ Ù‡Ù…Ú©Ø§Ø±ÛŒ</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');

    body {
      font-family: 'Vazirmatn', sans-serif;
      background: #f4f6f9;
      max-width: 950px;
      margin: 40px auto;
      padding: 20px;
      color: #333;
      line-height: 1.9;
    }

    h1 {
      text-align: center;
      border-bottom: 3px solid #3498db;
      padding-bottom: 10px;
      margin-bottom: 30px;
      color: #2c3e50;
    }

    .section {
      background: #fff;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.05);
    }

    .section h2 {
      color: #0057a3;
      font-size: 20px;
      margin-bottom: 15px;
    }

    .section h3 {
      color: #1f3b73;
      font-size: 18px;
      margin: 20px 0 10px;
    }

    .analysis-text {
      font-size: 16px;
      color: #444;
      margin-bottom: 15px;
    }

    .impact-list {
      list-style-type: disc;
      padding-right: 20px;
      font-size: 16px;
      color: #333;
    }

    .btn {
      background: #3498db;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: bold;
      margin: 10px 5px 0 0;
      cursor: pointer;
      transition: 0.3s;
      font-family: 'Vazirmatn', sans-serif;
    }

    .btn:hover { 
      background: #217dbb; 
    }

    .btn-success {
      background: #27ae60;
    }

    .btn-success:hover {
      background: #229954;
    }

    .btn-danger {
      background: #e74c3c;
    }

    .btn-danger:hover {
      background: #c0392b;
    }

    .btn-warning {
      background: #f39c12;
    }

    .btn-warning:hover {
      background: #e67e22;
    }

    .btn-disabled {
      background: #95a5a6;
      cursor: not-allowed;
    }

    .btn-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 20px;
    }

    .collaboration-section {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border: 2px solid #dee2e6;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 25px;
    }

    .collaboration-section h2 {
      color: #495057;
      margin-bottom: 15px;
    }

    .status-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      margin-left: 10px;
    }

    .status-pending {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .status-accepted {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status-sent {
      background: #cce5ff;
      color: #004085;
      border: 1px solid #b3d7ff;
    }

    .idea-info {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #dee2e6;
    }

    .idea-info h3 {
      margin: 0 0 10px 0;
      color: #2c3e50;
    }

    .idea-info p {
      margin: 5px 0;
      color: #555;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #7f8c8d;
    }

    .error {
      background: #fdf2f2;
      border: 1px solid #fecaca;
      color: #e74c3c;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }

    .success {
      background: #f0f9ff;
      border: 1px solid #bae6fd;
      color: #0369a1;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }
  </style>
</head>
<body>

<h1 id="pageTitle">Ø¬Ø²Ø¦ÛŒØ§Øª Ø§ÛŒØ¯Ù‡ Ù‡Ù…Ú©Ø§Ø±ÛŒ</h1>

<!-- Idea Information Section -->
<div class="section idea-info" id="ideaInfoSection">
  <h3>ğŸ“‹ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ÛŒØ¯Ù‡</h3>
  <div id="ideaInfo">
    <p><strong>Ø¹Ù†ÙˆØ§Ù† Ø§ÛŒØ¯Ù‡:</strong> <span id="ideaTitleDisplay">-</span></p>
    <p><strong>Ø¨Ø±Ù†Ø¯ Ù‡Ù…Ú©Ø§Ø±:</strong> <span id="partnerNameDisplay">-</span></p>
    <p><strong>ØªÙˆØ¶ÛŒØ­Ø§Øª:</strong> <span id="ideaDescriptionDisplay">-</span></p>
  </div>
</div>

<!-- Collaboration Status Section -->
<div class="collaboration-section" id="collaborationSection">
  <h2>ğŸ¤ ÙˆØ¶Ø¹ÛŒØª Ù‡Ù…Ú©Ø§Ø±ÛŒ</h2>
  <div id="collaborationStatus">
    <div class="loading">â³ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª...</div>
  </div>
  <div id="collaborationButtons" style="margin-top: 20px; text-align: center;">
    <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù‡Ù…Ú©Ø§Ø±ÛŒ Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
  </div>
</div>

<div class="section">
  <h2>Ú†Ø±Ø§ Ø¨Ø§ÛŒØ¯ Ø§ÛŒÙ† Ø§ÛŒØ¯Ù‡ Ø±Ø§ Ø§Ø² Ø²Ø§ÙˆÛŒÙ‡ CSRØŒ PR Ùˆ Branding Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø±Ø¯ØŸ</h2>
  <div id="analysis" class="analysis-text">â³ Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª ØªØ­Ù„ÛŒÙ„...</div>
</div>

<div class="btn-container">
  <button class="btn" id="btnSample">ğŸ“Œ Ù†Ù…ÙˆÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø¬Ø±Ø§ Ø´Ø¯Ù‡</button>
  <button class="btn" id="btnBenefits">ğŸ¤ Ù…Ø²Ø§ÛŒØ§ Ø¨Ø±Ø§ÛŒ Ø·Ø±ÙÛŒÙ†</button>
  <button class="btn" id="btnRevenue">ğŸ’° Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ø¯Ø±Ø¢Ù…Ø¯ÛŒ</button>
  <button class="btn" id="btnEconomy">ğŸ“Š ØªÙˆØ¬ÛŒÙ‡ Ø§Ù‚ØªØµØ§Ø¯ÛŒ</button>
  <button class="btn" id="btnStrategy">ğŸ“ˆ ÛŒÚ© Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡Ù…</button>
  <button class="btn" id="btnBack">ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</button>
</div>

<script>
let currentIdeaId = null;
let collaborationStatus = null;

// Ø¯Ø±ÛŒØ§ÙØª Ø´Ù†Ø§Ø³Ù‡ Ø§ÛŒØ¯Ù‡ Ø§Ø² URL ÛŒØ§ sessionStorage
function getIdeaId() {
  const params = new URLSearchParams(window.location.search);
  const ideaId = params.get("id");
  
  if (ideaId) {
    return ideaId;
  }
  
  // Ø§Ú¯Ø± ID Ø¯Ø± URL Ù†ÛŒØ³ØªØŒ Ø§Ø² sessionStorage Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†
  return sessionStorage.getItem("ideaId");
}

// Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø§ÛŒØ¯Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¹Ù†ÙˆØ§Ù† Ùˆ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø±Ù†Ø¯
async function findIdeaByTitle() {
  try {
    const ideaTitle = sessionStorage.getItem("ideaTitle");
    const targetBrandId = sessionStorage.getItem("targetBrandId");
    
    if (!ideaTitle || !targetBrandId) {
      throw new Error("Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ÛŒØ¯Ù‡ Ù†Ø§Ù‚Øµ Ø§Ø³Øª");
    }
    
    // Ø¯Ø±ÛŒØ§ÙØª Ø¨Ø±Ù†Ø¯ Ø®ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø±
    const myBrandResponse = await fetch("/api/my-brand", {
      credentials: 'include'
    });
    
    if (!myBrandResponse.ok) {
      throw new Error("Ø¨Ø±Ù†Ø¯ Ø´Ù…Ø§ ÛŒØ§ÙØª Ù†Ø´Ø¯");
    }
    
    const myBrand = await myBrandResponse.json();
    
    // Ø¬Ø³ØªØ¬ÙˆÛŒ Ø§ÛŒØ¯Ù‡ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³
    const ideasResponse = await fetch(`/api/ideas/partner/${targetBrandId}`, {
      credentials: 'include'
    });
    
    if (!ideasResponse.ok) {
      throw new Error("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§ÛŒØ¯Ù‡â€ŒÙ‡Ø§");
    }
    
    const ideas = await ideasResponse.json();
    
    // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø§ÛŒØ¯Ù‡ Ø¨Ø§ Ø¹Ù†ÙˆØ§Ù† Ù…Ø·Ø§Ø¨Ù‚
    const matchingIdea = ideas.find(idea => 
      idea.title === ideaTitle && 
      (idea.myBrandId._id === myBrand._id || idea.partnerBrandId._id === myBrand._id)
    );
    
    if (matchingIdea) {
      return matchingIdea._id;
    }
    
    // Ø§Ú¯Ø± Ø§ÛŒØ¯Ù‡ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ØŒ ÛŒÚ© Ø§ÛŒØ¯Ù‡ Ø¬Ø¯ÛŒØ¯ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†
    return await createNewIdea(ideaTitle, sessionStorage.getItem("ideaDescription"), targetBrandId);
    
  } catch (error) {
    console.error("Ø®Ø·Ø§ Ø¯Ø± Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø§ÛŒØ¯Ù‡:", error);
    throw error;
  }
}

// Ø§ÛŒØ¬Ø§Ø¯ Ø§ÛŒØ¯Ù‡ Ø¬Ø¯ÛŒØ¯
async function createNewIdea(title, description, partnerBrandId) {
  try {
    const response = await fetch('/api/ideas', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      credentials: 'include',
      body: JSON.stringify({
        title: title,
        description: description,
        partnerBrandId: partnerBrandId
      })
    });
    
    if (!response.ok) {
      throw new Error("Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø§ÛŒØ¯Ù‡ Ø¬Ø¯ÛŒØ¯");
    }
    
    const result = await response.json();
    return result.idea._id;
    
  } catch (error) {
    console.error("Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø§ÛŒØ¯Ù‡ Ø¬Ø¯ÛŒØ¯:", error);
    throw error;
  }
}

// Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ÛŒØ¯Ù‡
async function fetchIdeaDetails(ideaId) {
  try {
    console.log('ğŸ” Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ÛŒØ¯Ù‡ Ø¨Ø§ ID:', ideaId);
    const response = await fetch(`/api/ideas/${ideaId}`, {
      credentials: 'include'
    });
    
    console.log('ğŸ” Ù¾Ø§Ø³Ø® API:', response.status, response.statusText);
    
    if (!response.ok) {
      const errorData = await response.json();
      console.error('ğŸ” Ø®Ø·Ø§ÛŒ API:', errorData);
      throw new Error(errorData.error || 'Ø§ÛŒØ¯Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯');
    }
    
    const idea = await response.json();
    console.log('ğŸ” Ø§ÛŒØ¯Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯Ù‡:', idea);
    return idea;
  } catch (error) {
    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ÛŒØ¯Ù‡:', error);
    throw error;
  }
}

// Ø¯Ø±ÛŒØ§ÙØª ÙˆØ¶Ø¹ÛŒØª Ù‡Ù…Ú©Ø§Ø±ÛŒ
async function fetchCollaborationStatus(ideaId) {
  try {
    const response = await fetch(`/api/ideas/${ideaId}/collaboration-status`, {
      credentials: 'include'
    });
    
    if (!response.ok) {
      throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ÙˆØ¶Ø¹ÛŒØª Ù‡Ù…Ú©Ø§Ø±ÛŒ');
    }
    
    return await response.json();
  } catch (error) {
    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ÙˆØ¶Ø¹ÛŒØª Ù‡Ù…Ú©Ø§Ø±ÛŒ:', error);
    throw error;
  }
}

// Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ÛŒØ¯Ù‡
function displayIdeaInfo(idea) {
  document.getElementById("ideaTitleDisplay").textContent = idea.title;
  document.getElementById("ideaDescriptionDisplay").textContent = idea.description;
  document.getElementById("pageTitle").textContent = `Ø¬Ø²Ø¦ÛŒØ§Øª Ø§ÛŒØ¯Ù‡: ${idea.title}`;
}

// Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª Ù‡Ù…Ú©Ø§Ø±ÛŒ
function displayCollaborationStatus(status) {
  const statusDiv = document.getElementById("collaborationStatus");
  const buttonsDiv = document.getElementById("collaborationButtons");
  
  let statusText = '';
  let statusClass = '';
  
  if (status.hasSentRequest) {
    if (status.sentRequestStatus === 'pending') {
      statusText = 'Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ù…Ú©Ø§Ø±ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡ - Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ù¾Ø§Ø³Ø®';
      statusClass = 'status-sent';
    } else if (status.sentRequestStatus === 'accepted') {
      statusText = 'Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ù…Ú©Ø§Ø±ÛŒ Ù¾Ø°ÛŒØ±ÙØªÙ‡ Ø´Ø¯Ù‡';
      statusClass = 'status-accepted';
    }
  } else if (status.hasReceivedRequest) {
    if (status.receivedRequestStatus === 'pending') {
      statusText = 'Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ù…Ú©Ø§Ø±ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯Ù‡ - Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ù¾Ø§Ø³Ø® Ø´Ù…Ø§';
      statusClass = 'status-pending';
    } else if (status.receivedRequestStatus === 'accepted') {
      statusText = 'Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ù…Ú©Ø§Ø±ÛŒ Ù¾Ø°ÛŒØ±ÙØªÙ‡ Ø´Ø¯Ù‡';
      statusClass = 'status-accepted';
    }
  } else {
    statusText = 'Ù‡ÛŒÚ† Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ù…Ú©Ø§Ø±ÛŒ Ø§Ø±Ø³Ø§Ù„ Ù†Ø´Ø¯Ù‡';
    statusClass = 'status-pending';
  }
  
  statusDiv.innerHTML = `
    <div class="status-badge ${statusClass}">${statusText}</div>
  `;
  
  // Ù†Ù…Ø§ÛŒØ´ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ù†Ø§Ø³Ø¨
  buttonsDiv.innerHTML = '';
  
  // Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± ØµØ§Ø­Ø¨ Ø§ÛŒØ¯Ù‡ Ø§Ø³Øª (isOwner = true)
  if (status.isOwner) {
    if (status.canSendRequest) {
      // Ú©Ø§Ø±Ø¨Ø± ØµØ§Ø­Ø¨ Ø§ÛŒØ¯Ù‡ Ø§Ø³Øª Ùˆ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø±Ø³Ø§Ù„ Ú©Ù†Ø¯
      const sendBtn = document.createElement('button');
      sendBtn.className = 'btn btn-success';
      sendBtn.textContent = 'ğŸ¤ Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ù…Ú©Ø§Ø±ÛŒ';
      sendBtn.onclick = () => sendCollaborationRequest();
      buttonsDiv.appendChild(sendBtn);
    } else if (status.hasSentRequest && status.sentRequestStatus === 'pending') {
      // Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡ Ùˆ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ù¾Ø§Ø³Ø®
      const waitingBtn = document.createElement('button');
      waitingBtn.className = 'btn btn-disabled';
      waitingBtn.textContent = 'â³ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ù¾Ø§Ø³Ø®';
      waitingBtn.disabled = true;
      buttonsDiv.appendChild(waitingBtn);
    } else if (status.hasSentRequest && status.sentRequestStatus === 'accepted') {
      // Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù¾Ø°ÛŒØ±ÙØªÙ‡ Ø´Ø¯Ù‡
      const acceptedBtn = document.createElement('button');
      acceptedBtn.className = 'btn btn-disabled';
      acceptedBtn.textContent = 'âœ… Ù‡Ù…Ú©Ø§Ø±ÛŒ Ù¾Ø°ÛŒØ±ÙØªÙ‡ Ø´Ø¯Ù‡';
      acceptedBtn.disabled = true;
      buttonsDiv.appendChild(acceptedBtn);
    }
  } 
  // Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†Ù†Ø¯Ù‡ Ø§Ø³Øª (isPartner = true)
  else if (status.isPartner) {
    if (status.canAcceptRequest) {
      // Ú©Ø§Ø±Ø¨Ø± Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†Ù†Ø¯Ù‡ Ø§Ø³Øª Ùˆ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø±Ø§ Ø¨Ù¾Ø°ÛŒØ±Ø¯
      const acceptBtn = document.createElement('button');
      acceptBtn.className = 'btn btn-danger';
      acceptBtn.textContent = 'âœ… Ù¾Ø°ÛŒØ±ÙØªÙ† Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ù…Ú©Ø§Ø±ÛŒ';
      acceptBtn.onclick = () => acceptCollaborationRequest(status.receivedRequestId);
      buttonsDiv.appendChild(acceptBtn);
    } else if (status.hasReceivedRequest && status.receivedRequestStatus === 'accepted') {
      // Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø±ÛŒØ§ÙØªÛŒ Ù¾Ø°ÛŒØ±ÙØªÙ‡ Ø´Ø¯Ù‡
      const acceptedBtn = document.createElement('button');
      acceptedBtn.className = 'btn btn-disabled';
      acceptedBtn.textContent = 'âœ… Ù‡Ù…Ú©Ø§Ø±ÛŒ Ù¾Ø°ÛŒØ±ÙØªÙ‡ Ø´Ø¯Ù‡';
      acceptedBtn.disabled = true;
      buttonsDiv.appendChild(acceptedBtn);
    }
  }
}

// Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ù…Ú©Ø§Ø±ÛŒ
async function sendCollaborationRequest() {
  try {
    const response = await fetch('/api/cooperation-requests', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      credentials: 'include',
      body: JSON.stringify({
        targetBrandId: collaborationStatus.isOwner ? 
          (await fetchIdeaDetails(currentIdeaId)).partnerBrandId : 
          (await fetchIdeaDetails(currentIdeaId)).myBrandId,
        ideaTitle: collaborationStatus.ideaTitle,
        ideaDescription: collaborationStatus.ideaDescription
      })
    });

    if (response.ok) {
      alert('Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ù…Ú©Ø§Ø±ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯');
      // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª
      await loadCollaborationStatus();
    } else {
      const error = await response.json();
      alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª: ' + error.error);
    }
  } catch (error) {
    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ù…Ú©Ø§Ø±ÛŒ:', error);
    alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ù…Ú©Ø§Ø±ÛŒ');
  }
}

// Ù¾Ø°ÛŒØ±ÙØªÙ† Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ù…Ú©Ø§Ø±ÛŒ
async function acceptCollaborationRequest(requestId) {
  try {
    const response = await fetch(`/api/cooperation-requests/${requestId}/accept`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      credentials: 'include'
    });

    if (response.ok) {
      alert('Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ù…Ú©Ø§Ø±ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾Ø°ÛŒØ±ÙØªÙ‡ Ø´Ø¯');
      // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª
      await loadCollaborationStatus();
    } else {
      const error = await response.json();
      alert('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø°ÛŒØ±Ø´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª: ' + error.error);
    }
  } catch (error) {
    console.error('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø°ÛŒØ±Ø´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ù…Ú©Ø§Ø±ÛŒ:', error);
    alert('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø°ÛŒØ±Ø´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ù…Ú©Ø§Ø±ÛŒ');
  }
}

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙˆØ¶Ø¹ÛŒØª Ù‡Ù…Ú©Ø§Ø±ÛŒ
async function loadCollaborationStatus() {
  try {
    const status = await fetchCollaborationStatus(currentIdeaId);
    collaborationStatus = status;
    displayCollaborationStatus(status);
  } catch (error) {
    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙˆØ¶Ø¹ÛŒØª Ù‡Ù…Ú©Ø§Ø±ÛŒ:', error);
    document.getElementById("collaborationStatus").innerHTML = 
      '<div class="error">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙˆØ¶Ø¹ÛŒØª Ù‡Ù…Ú©Ø§Ø±ÛŒ</div>';
  }
}

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØ­Ù„ÛŒÙ„ Ø§ÛŒØ¯Ù‡
async function loadIdeaAnalysis() {
  try {
    const idea = await fetchIdeaDetails(currentIdeaId);
    
    // Ø§Ú¯Ø± Ø§ÛŒØ¯Ù‡â€ŒØ§ÛŒ Ø¯Ø± sessionStorage Ù†ÛŒØ³ØªØŒ Ø¢Ù† Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†
    if (!sessionStorage.getItem("ideaPrompt")) {
      sessionStorage.setItem("ideaPrompt", idea.title + '\n\n' + idea.description);
      sessionStorage.setItem("ideaTitle", idea.title);
      sessionStorage.setItem("ideaDescription", idea.description);
    }

    const analysisDiv = document.getElementById("analysis");
    analysisDiv.textContent = "â³ Ø¯Ø± Ø­Ø§Ù„ ØªØ­Ù„ÛŒÙ„...";

    // ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ API Ø¨Ø±Ø§ÛŒ ØªØ­Ù„ÛŒÙ„
    const response = await fetch("/api/generate-ideas", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ 
        prompt: `Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø²ÛŒØ±:
${idea.title}

${idea.description}

ÛŒÚ© ØªØ­Ù„ÛŒÙ„ ØºÙ†ÛŒ Ùˆ Ù¾Ø±Ù…Ø­ØªÙˆØ§ (Û´â€“Ûµ Ø®Ø·) Ø¨Ù†ÙˆÛŒØ³ Ú©Ù‡ ØªÙˆØ¶ÛŒØ­ Ø¯Ù‡Ø¯ Ú†Ø±Ø§ Ø§ÛŒÙ† Ø§ÛŒØ¯Ù‡ Ø¨Ø§ÛŒØ¯ Ø§Ø² Ø²Ø§ÙˆÛŒÙ‡â€ŒÙ‡Ø§ÛŒ Ù…Ø³Ø¦ÙˆÙ„ÛŒØª Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ (CSR)ØŒ Ø±ÙˆØ§Ø¨Ø· Ø¹Ù…ÙˆÙ…ÛŒ (PR) Ùˆ Ø¨Ø±Ù†Ø¯Ø³Ø§Ø²ÛŒ (Branding) Ø¨Ø±Ø±Ø³ÛŒ Ø´ÙˆØ¯. Ø§ÛŒÙ† ØªØ­Ù„ÛŒÙ„ Ø¨Ø§ÛŒØ¯ Ø¹Ù…ÛŒÙ‚ Ùˆ Ù…ØªÙ‚Ø§Ø¹Ø¯Ú©Ù†Ù†Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ Ùˆ Ù…Ø²Ø§ÛŒØ§ÛŒ Ø§ÛŒÙ† Ù‡Ù…Ú©Ø§Ø±ÛŒ Ø±Ø§ Ø§Ø² Ù‡Ø± Ø³Ù‡ Ø²Ø§ÙˆÛŒÙ‡ Ø¨Ù‡ Ø·ÙˆØ± Ø¬Ø§Ù…Ø¹ Ù¾ÙˆØ´Ø´ Ø¯Ù‡Ø¯.

Ù‡ÛŒÚ† Ù…Ù‚Ø¯Ù…Ù‡ ÛŒØ§ Ù†ØªÛŒØ¬Ù‡â€ŒÚ¯ÛŒØ±ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ù†Ù†ÙˆÛŒØ³. ÙÙ‚Ø· Ù‡Ù…ÛŒÙ† ØªØ­Ù„ÛŒÙ„ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³.`,
        myBrandId: idea.myBrandId,
        targetBrandId: idea.partnerBrandId
      })
    });

    if (response.ok) {
      const data = await response.json();
      const analysis = data.choices[0].message.content;
      analysisDiv.innerHTML = analysis.replace(/\n/g, "<br>");
    } else {
      analysisDiv.innerHTML = `
        <div class="error">
          <h4>âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØ­Ù„ÛŒÙ„ Ø§ÛŒØ¯Ù‡</h4>
          <p>Ù…ØªØ£Ø³ÙØ§Ù†Ù‡ Ø§Ù…Ú©Ø§Ù† ØªØ­Ù„ÛŒÙ„ Ø§ÛŒØ¯Ù‡ Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</p>
        </div>
      `;
    }
  } catch (error) {
    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØ­Ù„ÛŒÙ„ Ø§ÛŒØ¯Ù‡:', error);
    document.getElementById("analysis").innerHTML = `
      <div class="error">
        <h4>âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØ­Ù„ÛŒÙ„ Ø§ÛŒØ¯Ù‡</h4>
        <p>${error.message}</p>
      </div>
    `;
  }
}

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø±Ù†Ø¯ Ù‡Ù…Ú©Ø§Ø±
async function loadPartnerInfo(idea) {
  try {
    const partnerBrandId = idea.myBrandId.toString() === collaborationStatus?.isOwner ? 
      idea.partnerBrandId : idea.myBrandId;
    
    const response = await fetch(`/api/brand/${partnerBrandId}`, {
      credentials: 'include'
    });
    
    if (response.ok) {
      const partnerBrand = await response.json();
      document.getElementById("partnerNameDisplay").textContent = partnerBrand.name;
    }
  } catch (error) {
    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø±Ù†Ø¯ Ù‡Ù…Ú©Ø§Ø±:', error);
    document.getElementById("partnerNameDisplay").textContent = 'Ø¨Ø±Ù†Ø¯ Ù‡Ù…Ú©Ø§Ø±';
  }
}

// Event Listeners
document.getElementById("btnBack").addEventListener("click", () => {
  window.location.href = "dashboard.html";
});

document.getElementById("btnSample").addEventListener("click", () => {
  alert("ğŸ“Œ Ù†Ù…ÙˆÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø¬Ø±Ø§ Ø´Ø¯Ù‡ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ ÙØ¹Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯");
});

document.getElementById("btnBenefits").addEventListener("click", () => {
  alert("ğŸ¤ Ù…Ø²Ø§ÛŒØ§ Ø¨Ø±Ø§ÛŒ Ø·Ø±ÙÛŒÙ† Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ ÙØ¹Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯");
});

document.getElementById("btnRevenue").addEventListener("click", () => {
  alert("ğŸ’° Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ø¯Ø±Ø¢Ù…Ø¯ÛŒ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ ÙØ¹Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯");
});

document.getElementById("btnEconomy").addEventListener("click", () => {
  alert("ğŸ“Š ØªÙˆØ¬ÛŒÙ‡ Ø§Ù‚ØªØµØ§Ø¯ÛŒ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ ÙØ¹Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯");
});

document.getElementById("btnStrategy").addEventListener("click", () => {
  alert("ğŸ“ˆ Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ ÙØ¹Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯");
});

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ØµÙØ­Ù‡
window.onload = async () => {
  try {
    currentIdeaId = getIdeaId();
    console.log('ğŸ” currentIdeaId Ø§Ø² getIdeaId:', currentIdeaId);
    
    // Ø§Ú¯Ø± ID Ø¯Ø± URL ÛŒØ§ sessionStorage Ù†ÛŒØ³ØªØŒ Ø³Ø¹ÛŒ Ú©Ù† Ø¢Ù† Ø±Ø§ Ù¾ÛŒØ¯Ø§ Ú©Ù†
    if (!currentIdeaId) {
      try {
        console.log('ğŸ” Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ¯Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¹Ù†ÙˆØ§Ù†...');
        currentIdeaId = await findIdeaByTitle();
        sessionStorage.setItem("ideaId", currentIdeaId);
        console.log('ğŸ” Ø§ÛŒØ¯Ù‡ Ù¾ÛŒØ¯Ø§ Ø´Ø¯ Ø¨Ø§ ID:', currentIdeaId);
      } catch (error) {
        console.error("Ø®Ø·Ø§ Ø¯Ø± Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø§ÛŒØ¯Ù‡:", error);
        document.getElementById("analysis").innerHTML = `
          <div class="error">
            <h4>âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</h4>
            <p>Ø§ÛŒØ¯Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ø·Ø±ÛŒÙ‚ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.</p>
            <button onclick="window.location.href='dashboard.html'" class="btn">
              ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
            </button>
          </div>
        `;
        return;
      }
    }
    
    if (!currentIdeaId) {
      console.error('âŒ currentIdeaId Ù‡Ù†ÙˆØ² null Ø§Ø³Øª');
      document.getElementById("analysis").innerHTML = `
        <div class="error">
          <h4>âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</h4>
          <p>Ø´Ù†Ø§Ø³Ù‡ Ø§ÛŒØ¯Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ø·Ø±ÛŒÙ‚ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.</p>
          <button onclick="window.location.href='dashboard.html'" class="btn">
            ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
          </button>
        </div>
      `;
      return;
    }
    
    console.log('ğŸ” Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÛŒØ¯Ù‡ Ø¨Ø§ ID:', currentIdeaId);

    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ÛŒØ¯Ù‡
    const idea = await fetchIdeaDetails(currentIdeaId);
    displayIdeaInfo(idea);
    
    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙˆØ¶Ø¹ÛŒØª Ù‡Ù…Ú©Ø§Ø±ÛŒ
    await loadCollaborationStatus();
    
    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø±Ù†Ø¯ Ù‡Ù…Ú©Ø§Ø±
    await loadPartnerInfo(idea);
    
    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØ­Ù„ÛŒÙ„ Ø§ÛŒØ¯Ù‡
    await loadIdeaAnalysis();
    
  } catch (error) {
    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØµÙØ­Ù‡:', error);
    document.getElementById("analysis").innerHTML = `
      <div class="error">
        <h4>âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</h4>
        <p>${error.message}</p>
        <button onclick="window.location.href='dashboard.html'" class="btn">
          ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
        </button>
      </div>
    `;
  }
};
</script>
</body>
</html>