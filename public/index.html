<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>فرم ثبت برند – نسخه دینامیک</title>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    body { font-family: sans-serif; background-color: #fff; padding: 20px; direction: rtl; max-width: 700px; margin: auto; }
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
    .tab { border: 2px solid #000; padding: 5px 15px; cursor: pointer; }
    .tab.active { background-color: #000; color: #fff; }
    .container { max-width: 600px; margin: auto; }
    .section { border: 2px solid #000; padding: 10px; margin-bottom: 15px; }
    textarea { width: 100%; height: 110px; border: none; resize: vertical; font-size: 14px; outline: none; background: transparent; }
    .form-instruction { font-weight: bold; font-size: 22px; margin: 35px 0 25px; color: #333; text-align: right; }
    .dropdown, .dropdown-toggle { width: 100%; }
    .dropdown-toggle { padding: 10px; border: 2px solid #000; cursor: pointer; background-color: #fff; position: relative; }
    .dropdown-menu { position: absolute; width: 100%; border: 2px solid #000; border-top: none; background-color: #fff; display: none; z-index: 100; }
    .dropdown-menu div { padding: 10px; cursor: pointer; }
    .dropdown-menu div:hover { background-color: #f0f0f0; }
    .form-row { display: flex; align-items: center; margin-bottom: 20px; position: relative; }
    .form-row label { font-weight: bold; width: 150px; text-align: right; padding-left: 15px; }
    .section-divider { border-bottom: 2px solid #000; margin: 20px 0; }
    .priority-item { border: 2px solid #000; padding: 10px; margin-bottom: 10px; background-color: #f9f9f9; cursor: move; display: flex; flex-direction: row-reverse; justify-content: space-between; align-items: center; }
    .priority-text { flex: 1; text-align: right; padding-right: 10px; }
    .priority-number { font-weight: bold; color: #555; min-width: 20px; text-align: center; }
    .save-button { background-color: #000; color: #fff; border: none; padding: 10px 20px; cursor: pointer; margin-top: 10px; }
    .hidden { display: none; }
  </style>
</head>
<body>
<div style="text-align:left; margin-bottom: 15px;">
  <span id="userStatus"></span>
  <button onclick="logout()" style="margin-left: 10px;">خروج</button>
</div>

<h2>فرم ثبت برند</h2>

<!-- Tabs -->
<div class="tabs">
  <div class="tab active" onclick="switchTab('essentials')">ملزومات</div>
  <div class="tab" onclick="switchTab('extra')">تکمیلی</div>
  <div class="tab" onclick="switchTab('priority')">اولویت‌ها</div>
</div>

<div class="container">
  <!-- Essentials Tab -->
  <div id="essentials-tab">
    <div class="form-row">
      <label>دسته‌بندی صنعت:</label>
      <div class="dropdown" id="industry-dropdown">
        <div class="dropdown-toggle" onclick="toggleMenu('industry')">فناوری اطلاعات ▼</div>
        <div class="dropdown-menu" id="industry-menu">
          <div onclick="selectOption('industry', 'فناوری اطلاعات')">فناوری اطلاعات</div>
          <div onclick="selectOption('industry', 'غذا و دارو')">غذا و دارو</div>
          <div onclick="selectOption('industry', 'ساختمان')">ساختمان</div>
        </div>
      </div>
    </div>

    <div class="form-row">
      <label>تعداد نیروی انسانی:</label>
      <div class="dropdown" id="staff-dropdown">
        <div class="dropdown-toggle" onclick="toggleMenu('staff')">۱–۱۰ نفر ▼</div>
        <div class="dropdown-menu" id="staff-menu">
          <div onclick="selectOption('staff', '۱–۱۰ نفر')">۱–۱۰ نفر</div>
          <div onclick="selectOption('staff', '۱۱–۵۰ نفر')">۱۱–۵۰ نفر</div>
          <div onclick="selectOption('staff', '۵۱–۲۰۰ نفر')">۵۱–۲۰۰ نفر</div>
        </div>
      </div>
    </div>

    <div class="section-divider"></div>
    <div class="form-instruction">لطفاً سؤالات زیر را پاسخ دهید:</div>

    <div id="essentials-questions"></div>
    <button class="save-button" onclick="goToTab('extra')">ذخیره و ادامه</button>
  </div>

  <!-- Extra Tab -->
  <div id="extra-tab" class="hidden">
    <div class="form-instruction">لطفاً برای تکمیل اطلاعات برند، سؤالات زیر را پاسخ دهید:</div>
    <div id="extra-questions"></div>
    <button class="save-button" onclick="goToTab('priority')">ذخیره و ادامه</button>
  </div>

  <!-- Priority Tab -->
  <div id="priority-tab" class="hidden">
    <div class="form-instruction">گزینه‌های زیر را بر اساس اولویت برند خود مرتب کنید:</div>
    <div id="priority-list">
      <div class="priority-item"><span class="priority-text">فرصت‌های توسعه بازار</span><span class="priority-number">1</span></div>
      <div class="priority-item"><span class="priority-text">جذب سرمایه</span><span class="priority-number">2</span></div>
      <div class="priority-item"><span class="priority-text">بهبود خدمات مشتری</span><span class="priority-number">3</span></div>
      <div class="priority-item"><span class="priority-text">توسعه محصول</span><span class="priority-number">4</span></div>
      <div class="priority-item"><span class="priority-text">افزایش فروش</span><span class="priority-number">5</span></div>
      <div class="priority-item"><span class="priority-text">توسعه تیم</span><span class="priority-number">6</span></div>
      <div class="priority-item"><span class="priority-text">ورود به بازار جدید</span><span class="priority-number">7</span></div>
      <div class="priority-item"><span class="priority-text">تبلیغات و بازاریابی</span><span class="priority-number">8</span></div>
      <div class="priority-item"><span class="priority-text">ارتقاء فناوری</span><span class="priority-number">9</span></div>
    </div>
    <button class="save-button" onclick="exportData()">ثبت نهایی اطلاعات</button>
  </div>
</div>

<script>
/********************  پرسش‌ها  ********************/
// Essentials (سؤالات 1 تا 30)
const essentialsQuestions = [
  {id: 1,  q: "برند خود را در یک جمله معرفی کنید.",                              ph: "ما پلتفرمی برای رزرو آنلاین آرایشگاه هستیم ..."},
  {id: 2,  q: "چه جایگاهی در بازار دارید؟",                                      ph: "ما برند مقرون‌به‌صرفه هستیم ..."},
  {id: 3,  q: "در چه فازی از رشد هستید؟ (شروع / تثبیت / رشد سریع / بلوغ / بازطراحی)", ph: "ما در فاز رشد سریع هستیم ..."},
  {id: 4,  q: "۳ اولویت اصلی برندتان در ۱۲ ماه آینده چیست؟ (به ترتیب اهمیت)",        ph: "۱. ورود به بازارهای جنوب کشور، ۲. ..."},
  {id: 5,  q: "در چه چیزهایی حاضرید سرمایه‌گذاری کنید؟ (پول، زمان، اعتبار)",        ph: "وقت و بودجه تبلیغاتی اختصاص می‌دهیم ..."},
  // 🔻 بخش محصول / خدمات / مدل کسب‌وکار
  {id: 6,  q: "محصولات / خدمات اصلی شما چیست؟ (با توضیح کوتاه)",                   ph: "یک نرم‌افزار CRM داریم ..."},
  {id: 7,  q: "چطور درآمدزایی می‌کنید؟",                                            ph: "از فروش اشتراک سالانه ..."},
  {id: 8,  q: "کدام‌یک از محصولاتتان قابلیت ترکیب با برندهای دیگر را دارد؟",      ph: "پکیج آموزش ما می‌تواند ..."},
  {id: 9,  q: "کدام بخش‌های کسب‌وکارتان مقیاس‌پذیر است؟",                          ph: "پشتیبانی آنلاین ما ..."},
  {id: 10, q: "از چه کانال‌هایی فروش دارید؟",                                      ph: "۸۰٪ سایت، ۲۰٪ نماینده فروش ..."},
  {id: 11, q: "محصولی دارید که بشه به‌عنوان هدیه یا پیشنهاد ترکیبی استفاده کرد؟", ph: "پکیج یک‌ماهه رایگان ..."},
  // 🔻 بخش منابع و ظرفیت‌ها
  {id: 12, q: "چه ظرفیت‌هایی دارید که می‌توانند در همکاری مشترک استفاده شوند؟",     ph: "یک فضای اداری ۴۰ متری ..."},
  {id: 13, q: "کدام منابع فعلاً کمتر از ظرفیت واقعی استفاده می‌شوند؟",             ph: "کانال تلگرام ۵۰۰۰ نفره ..."},
  {id: 14, q: "آیا مجاز به ارائه این منابع به بیرون هستید؟",                      ph: "بله، ولی فقط در همکاری‌های رسمی ..."},
  // 🔻 بخش مخاطب‌شناسی
  {id: 15, q: "مشتری ایده‌آل شما کیست؟ (سن، صنعت، رفتار، دغدغه ...)",             ph: "زنان ۲۵ تا ۴۰ ساله شاغل ..."},
  {id: 16, q: "بیشتر مشتری‌ها از کجا جذب می‌شوند؟",                               ph: "۷۰٪ اینستاگرام ..."},
  {id: 17, q: "تعداد مخاطبین فعال شما چقدر است؟",                                  ph: "۲۰۰۰ مشتری فعال ..."},
  {id: 18, q: "مخاطبین شما بیشتر چه ویژگی روانی‌ای دارند؟",                      ph: "نوآور و اهل آزمون‌وخطا ..."},
  {id: 19, q: "مخاطب شما به چه برندهای دیگری علاقه‌مند است؟",                      ph: "فرادرس، مکتب‌خونه، نوین ..."},
  // 🔻 آمادگی برای همکاری برند به برند
  {id: 20, q: "تجربه‌ای از همکاری با برندهای دیگر داشتید؟",                        ph: "با یک برند نوشیدنی ..."},

  // 🔻 سؤال 27 و 30 (جزو ملزومات)
  {id: 21, q: "چه چیزی دارید که معمولاً به بیرون نمی‌دهید، ولی در همکاری خوب می‌توانید بدهید؟", ph: "دسترسی به CRM مشتریان VIP ..."},
  {id: 22, q: "چه چیزی باعث می‌شود یک همکاری را متوقف کنید؟",                       ph: "نبود شفافیت در اهداف ..."}
];

// Extra (سؤالات 31 تا 37)
const extraQuestions = [
  {id: 23, q: "برای رشد کسب‌وکارتان در یک سال آینده، چه قابلیت‌ها یا منابعی نیاز دارید که الان ندارید؟", ph: "نیاز به سیستم اتوماسیون بازاریابی ..."},
  {id: 24, q: "در حال حاضر کدام بخش از فعالیت‌هایتان زمان یا انرژی بیشتری می‌گیرد و چرا؟",            ph: "پاسخ به مشتری‌ها در واتساپ ..."},
  {id: 25, q: "اخیراً چه فرصت مهمی در بازار وجود داشته که حس می‌کنید به خاطر نداشتن آمادگی آن را از دست داده‌اید؟", ph: "یک پلتفرم گردشگری بزرگ ..."},
  {id: 26, q: "رقبای شما در چه زمینه‌ای عملکرد بهتری داشته‌اند یا چه کاری انجام داده‌اند که شما هنوز شروع نکرده‌اید؟", ph: "رقیب‌مون یک پلتفرم معرفی مشتری ..."},
  {id: 27, q: "فکر می‌کنید کدام معیار یا شاخص در کسب‌وکارتان نیازمند توجه بیشتر است؟",                 ph: "نرخ بازگشت مشتری پایین ..."},
  {id: 28, q: "در حال حاضر بزرگترین چالش‌هایی که برای توسعه کسب‌وکارتان دارید کدامند؟",               ph: "کمبود نیروی برنامه‌نویس ..."},
  {id: 29, q: "معمولاً مشتریان چه پیشنهاداتی برای بهبود محصولات یا خدمات شما دارند؟",                ph: "موبایل‌وب‌سایت کند است ..."}
];

const allQuestions = [...essentialsQuestions, ...extraQuestions];
/********************  UI Functions  ********************/
function buildQuestions(containerId, questionsArr) {
  const parent = document.getElementById(containerId);
  questionsArr.forEach(({id, q, ph}) => {
    const wrap = document.createElement('div');
    wrap.className = 'section';

    const txt = document.createElement('textarea');
    txt.id = `answer-${id}`;
    txt.placeholder = ph || '';
    wrap.innerHTML = `<strong style="display:block; margin-bottom:8px;">${id}. ${q}</strong>`;
    wrap.appendChild(txt);
    parent.appendChild(wrap);
  });
}

// Build on load
window.addEventListener('DOMContentLoaded', () => {
  buildQuestions('essentials-questions', essentialsQuestions);
  buildQuestions('extra-questions', extraQuestions);
});

/********************  Tabs  ********************/
function switchTab(tabName) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('#essentials-tab, #extra-tab, #priority-tab').forEach(div => div.classList.add('hidden'));
  if (tabName === 'essentials') {
    document.getElementById('essentials-tab').classList.remove('hidden');
    document.querySelector('.tabs .tab:nth-child(1)').classList.add('active');
  } else if (tabName === 'extra') {
    document.getElementById('extra-tab').classList.remove('hidden');
    document.querySelector('.tabs .tab:nth-child(2)').classList.add('active');
  } else {
    document.getElementById('priority-tab').classList.remove('hidden');
    document.querySelector('.tabs .tab:nth-child(3)').classList.add('active');
  }
}
function goToTab(tab) { switchTab(tab); }

/********************  Dropdowns  ********************/
function toggleMenu(type) {
  const menu = document.getElementById(`${type}-menu`);
  menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
}
function selectOption(type, val) {
  document.querySelector(`#${type}-dropdown .dropdown-toggle`).innerText = val;
  document.getElementById(`${type}-menu`).style.display = 'none';
}
document.addEventListener('click', e => {
  ['industry', 'staff'].forEach(type => {
    const toggle = document.querySelector(`#${type}-dropdown .dropdown-toggle`);
    const menu = document.getElementById(`${type}-menu`);
    if (!toggle.contains(e.target) && !menu.contains(e.target)) menu.style.display = 'none';
  });
});

/********************  Priority Sortable  ********************/
new Sortable(document.getElementById('priority-list'), {
  animation: 150,
  onEnd: () => {
    Array.from(document.getElementById('priority-list').children).forEach((item, idx) => {
      item.querySelector('.priority-number').textContent = idx + 1;
    });
  }
});

/********************  Auth & Redirects  ********************/
window.onload = async () => {
  try {
    const authRes = await fetch('/api/check-auth', {credentials: 'include'});
    const authData = await authRes.json();
    if (!authData.authenticated) {
      alert('ابتدا وارد شوید.');
      window.location.href = 'login.html';
      return;
    }
    document.getElementById('userStatus').innerText = `کاربر وارد شده: ${authData.userId}`;

    const brandRes = await fetch('/api/check-brand', {credentials: 'include'});
    if (brandRes.ok) {
      const brandData = await brandRes.json();
      if (brandData.hasBrand) {
        alert('شما قبلاً برند خود را ثبت کرده‌اید.');
        window.location.href = 'brands.html';
        return;
      }
    }
  } catch (err) { console.error('خطا در بررسی وضعیت کاربر:', err); }
};

/********************  Export & Save  ********************/
async function exportData() {
  const brandName = prompt('نام برند را وارد کنید:');
  if (!brandName) return alert('نام برند را وارد کنید!');

  const industry = document.querySelector('#industry-dropdown .dropdown-toggle').innerText;
  const staff    = document.querySelector('#staff-dropdown .dropdown-toggle').innerText;

  // Collect answers
  const qa = allQuestions.map(({id, q}) => {
    const ans = document.getElementById(`answer-${id}`).value.trim();
    return {id, question: q, answer: ans};
  });

  // Priorities
  const priorities = Array.from(document.querySelectorAll('#priority-list .priority-item'))
                          .map(item => item.querySelector('.priority-text').innerText);

  const brandData = {
    name: brandName,
    field: industry,
    staff: staff,
    questions: qa,
    priorities: priorities
  };

  try {
    const res = await fetch('/api/brands', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      credentials: 'include',
      body: JSON.stringify(brandData)
    });
    const data = await res.json();
    if (res.ok) {
      alert(data.message || 'ثبت برند با موفقیت انجام شد.');
      window.location.href = 'brands.html';
    } else {
      alert(data.error || 'خطا در ثبت برند');
    }
  } catch (err) {
    alert('خطا در ارتباط با سرور');
  }
}

/********************  Logout  ********************/
async function logout() {
  await fetch('/api/logout', {method: 'POST', credentials: 'include'});
  window.location.href = 'login.html';
}
</script>

</body>
</html>
