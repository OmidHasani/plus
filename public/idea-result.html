<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>تحلیل حرفه‌ای ایده</title>
  <style>
    body {
      font-family: 'Vazirmatn', sans-serif;
      background: #f4f6f9;
      max-width: 950px;
      margin: 40px auto;
      padding: 20px;
      color: #333;
      line-height: 1.9;
    }
    h1 {
      text-align: center;
      border-bottom: 3px solid #3498db;
      padding-bottom: 10px;
      margin-bottom: 30px;
      color: #2c3e50;
    }
    .section {
      background: #fff;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.05);
    }
    .section h2 {
      color: #0057a3;
      font-size: 20px;
      margin-bottom: 15px;
    }
    .section h3 {
      color: #1f3b73;
      font-size: 18px;
      margin: 20px 0 10px;
    }
    .analysis-text {
      font-size: 16px;
      color: #444;
      margin-bottom: 15px;
    }
    .impact-list {
      list-style-type: disc;
      padding-right: 20px;
      font-size: 16px;
      color: #333;
    }
    .btn {
      background: #3498db;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: bold;
      margin: 10px 5px 0 0;
      cursor: pointer;
      transition: 0.3s;
    }
    .btn:hover { 
      background: #217dbb; 
    }
    .btn-red {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: bold;
      margin: 10px 5px 0 0;
      cursor: pointer;
      transition: 0.3s;
    }
    .btn-red:hover { 
      background: #c0392b; 
    }
    .btn-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 20px;
    }
    
    /* استایل‌های پاپ‌آپ */
    .popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      display: flex;
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.3s ease;
    }

    .popup-content {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      max-width: 400px;
      width: 90%;
      max-height: 80vh;
      overflow: hidden;
      animation: slideIn 0.3s ease;
    }

    .popup-header {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .popup-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
    }

    .popup-close {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background 0.3s ease;
    }

    .popup-close:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .popup-body {
      padding: 25px;
      text-align: center;
    }

    .popup-body p {
      margin: 0;
      font-size: 16px;
      line-height: 1.6;
      color: #333;
    }

    .popup-footer {
      padding: 20px;
      text-align: center;
      border-top: 1px solid #eee;
    }

    .popup-btn {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      font-family: 'Vazirmatn', sans-serif;
    }

    .popup-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(52, 152, 219, 0.4);
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideIn {
      from { 
        opacity: 0;
        transform: translateY(-50px) scale(0.9);
      }
      to { 
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
  </style>
  
  <!-- پاپ‌آپ زیبا -->
  <div id="popup-overlay" class="popup-overlay" style="display: none;">
    <div class="popup-content">
      <div class="popup-header">
        <h3 id="popup-title">اطلاعیه</h3>
        <button class="popup-close" onclick="closePopup()">&times;</button>
      </div>
      <div class="popup-body">
        <p id="popup-message">پیام در اینجا نمایش داده می‌شود</p>
      </div>
      <div class="popup-footer">
        <button class="popup-btn" onclick="closePopup()">متوجه شدم</button>
      </div>
    </div>
  </div>
</head>
<body>

<h1>تحلیل حرفه‌ای ایده همکاری</h1>

<div class="section">
  <h2>چرا باید این ایده را از زاویه CSR، PR و Branding بررسی کرد؟</h2>
  <div id="analysis" class="analysis-text">⏳ در حال دریافت تحلیل...</div>
</div>


<div class="btn-container">
  <button class="btn" id="btnSample">📌 نمونه‌های اجرا شده</button>
  <button class="btn" id="btnBenefits">🤝 مزایا برای طرفین</button>
  <button class="btn" id="btnRevenue">💰 مدل‌های درآمدی</button>
  <button class="btn" id="btnEconomy">📊 توجیه اقتصادی</button>
  <button class="btn" id="btnStrategy">📈 یک استراتژی می‌خواهم</button>
  <button class="btn-red" id="btnBack">🔙 بازگشت</button>
</div>

<script>
async function fetchMyBrand() {
  const res = await fetch("/api/my-brand", { credentials: "include" });
  if (!res.ok) throw new Error("برند شما یافت نشد.");
  return await res.json();
}

function getTargetBrandId() {
  const params = new URLSearchParams(window.location.search);
  return params.get("target");
}

async function callOpenAI(prompt, myBrandId, targetBrandId) {
  const res = await fetch("/api/generate-ideas", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ 
      prompt, 
      myBrandId, 
      targetBrandId 
    })
  });

  if (!res.ok) {
    const err = await res.json();
    throw new Error(err.error?.message || "خطا در پاسخ OpenAI");
  }

  const data = await res.json();
  console.log("خام API OpenAI:", JSON.stringify(data, null, 2));
  return data.choices[0].message.content;
}

function splitAnalysisAndImpacts(text) {
  const analysis = text.trim();
  return { analysis };
}

function showFallbackAnalysis(ideaPrompt) {
  const analysisDiv = document.getElementById("analysis");
  
  // تحلیل ساده و کلی
  analysisDiv.innerHTML = `
    <div style="color: #2c3e50; background: #ecf0f1; padding: 15px; border-radius: 8px; border: 1px solid #bdc3c7;">
      <h4 style="margin: 0 0 10px 0;">📊 تحلیل کلی ایده</h4>
      <p style="margin: 0;">این ایده از زوایای مختلف (CSR، PR، Branding) قابل بررسی است و می‌تواند برای هر دو برند مزایای قابل توجهی به همراه داشته باشد.</p>
    </div>
  `;
}

async function loadIdeaAnalysis() {
  const ideaPrompt = sessionStorage.getItem("ideaPrompt");
  const analysisDiv = document.getElementById("analysis");

  // اگر ایده‌ای در sessionStorage نیست، پیام مناسب نمایش بده
  if (!ideaPrompt) {
    analysisDiv.innerHTML = `
      <div style="color: #f39c12; background: #fef9e7; padding: 15px; border-radius: 8px; border: 1px solid #f4d03f;">
        <h4 style="margin: 0 0 10px 0;">⚠️ اطلاعات ایده یافت نشد</h4>
        <p style="margin: 0;">لطفاً ابتدا از صفحه فرصت‌های همکاری یک ایده را انتخاب کنید.</p>
        <button onclick="window.history.back()" style="margin-top: 10px; padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
          🔙 بازگشت
        </button>
      </div>
    `;
    return;
  }

  try {
    // دریافت اطلاعات برندها
    const myBrand = await fetchMyBrand();
    console.log("🔍 Debug - myBrand:", myBrand);
    
    let targetBrandId = sessionStorage.getItem("targetBrandId");
    console.log("🔍 Debug - targetBrandId from sessionStorage:", targetBrandId);
    
    if (!targetBrandId) {
      throw new Error("شناسه برند هدف یافت نشد.");
    }

    const newPrompt = `
بر اساس اطلاعات زیر:
${ideaPrompt}

یک تحلیل غنی و پرمحتوا (۴–۵ خط) بنویس که توضیح دهد چرا این ایده باید از زاویه‌های مسئولیت اجتماعی (CSR)، روابط عمومی (PR) و برندسازی (Branding) بررسی شود. این تحلیل باید عمیق و متقاعدکننده باشد و مزایای این همکاری را از هر سه زاویه به طور جامع پوشش دهد.

هیچ مقدمه یا نتیجه‌گیری اضافه ننویس. فقط همین تحلیل را بنویس.
`;

    analysisDiv.textContent = "⏳ در حال تحلیل...";
    const response = await callOpenAI(newPrompt, myBrand._id, targetBrandId);
    const { analysis } = splitAnalysisAndImpacts(response);

    analysisDiv.innerHTML = analysis.replace(/\n/g, "<br>");
  } catch (err) {
    console.error("خطا در تحلیل ایده:", err);
    
    // اگر خطای اتصال است، پیام مناسب نمایش بده
    if (err.message.includes("سرویس تحلیل ایده‌ها موقتاً در دسترس نیست") || err.message.includes("خطا در API")) {
      // نمایش تحلیل ساده به جای پیام خطا
      showFallbackAnalysis(ideaPrompt);
    } else {
      analysisDiv.innerHTML = `
        <div style="color: #e74c3c; background: #fdf2f2; padding: 15px; border-radius: 8px; border: 1px solid #fecaca;">
          <h4 style="margin: 0 0 10px 0;">❌ خطا در تحلیل ایده</h4>
          <p style="margin: 0;">${err.message}</p>
          <button onclick="loadIdeaAnalysis()" style="margin-top: 10px; padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
            🔄 تلاش مجدد
          </button>
        </div>
      `;
    }
  }
}

// توابع پاپ‌آپ
function showPopup(title, message) {
  document.getElementById('popup-title').textContent = title;
  document.getElementById('popup-message').textContent = message;
  document.getElementById('popup-overlay').style.display = 'flex';
}

function closePopup() {
  document.getElementById('popup-overlay').style.display = 'none';
}

document.getElementById("btnEconomy").addEventListener("click", () => {
  showPopup("📊 توجیه اقتصادی", "این قابلیت به زودی فعال می‌شود و توجیه اقتصادی کامل ایده را ارائه می‌دهد.");
});

document.getElementById("btnSample").addEventListener("click", () => {
  showPopup("📌 نمونه‌های اجرا شده", "این قابلیت به زودی فعال می‌شود و نمونه‌های واقعی مشابه این ایده را معرفی می‌کند.");
});

document.getElementById("btnBenefits").addEventListener("click", () => {
  showPopup("🤝 مزایا برای طرفین", "این قابلیت به زودی فعال می‌شود و مزایای همکاری برای هر دو طرف را نشان می‌دهد.");
});

document.getElementById("btnRevenue").addEventListener("click", () => {
  showPopup("💰 مدل‌های درآمدی", "این قابلیت به زودی فعال می‌شود و مدل‌های مختلف درآمدزایی را ارائه می‌دهد.");
});

document.getElementById("btnStrategy").addEventListener("click", () => {
  showPopup("📈 یک استراتژی می‌خواهم", "این قابلیت به زودی فعال می‌شود و استراتژی کاملاً اجرایی و جزئی را ارائه می‌دهد.");
});

document.getElementById("btnBack").addEventListener("click", () => {
  window.history.back();
});

window.onload = async () => {
  // دریافت targetBrandId از sessionStorage
  let targetBrandId = sessionStorage.getItem("targetBrandId");
  console.log("🔍 Debug - targetBrandId from sessionStorage:", targetBrandId);
  console.log("🔍 Debug - current URL:", window.location.href);
  console.log("🔍 Debug - search params:", window.location.search);
  
  // اگر targetBrandId در sessionStorage نیست، آن را از URL دریافت کن و ذخیره کن
  if (!targetBrandId) {
    targetBrandId = getTargetBrandId();
    console.log("🔍 Debug - targetBrandId from URL:", targetBrandId);
    if (targetBrandId) {
      sessionStorage.setItem("targetBrandId", targetBrandId);
      console.log("✅ targetBrandId from URL saved to sessionStorage:", targetBrandId);
    }
  }
  
  // اگر هنوز targetBrandId نداریم، پیام خطا نمایش بده
  if (!targetBrandId) {
    const analysisDiv = document.getElementById("analysis");
    analysisDiv.innerHTML = `
      <div style="color: #e74c3c; background: #fdf2f2; padding: 15px; border-radius: 8px; border: 1px solid #fecaca;">
        <h4 style="margin: 0 0 10px 0;">❌ خطا در بارگذاری</h4>
        <p style="margin: 0;">شناسه برند هدف یافت نشد. لطفاً ابتدا از صفحه فرصت‌های همکاری یک ایده را انتخاب کنید.</p>
        <button onclick="window.history.back()" style="margin-top: 10px; padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
          🔙 بازگشت
        </button>
      </div>
    `;
    return;
  }
  
  // بارگذاری تحلیل ایده
  await loadIdeaAnalysis();
};
</script>
</body>
</html>
